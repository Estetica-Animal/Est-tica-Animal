<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Estética Animal — Agenda & Tutores</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --rosa:#ff66a3;
  --rosa-escuro:#ff3385;
  --bg:#fff0f6;
  --card:#ffffff;
  --texto:#444;
  --sombra:0 4px 8px rgba(255,102,163,.3);
  --azul:#007bff;
  --verde:#28a745;
  --cinza:#d6d6d6;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--texto); margin:0;}

header{
  position:fixed; top:0; left:0; right:0; background:var(--rosa); color:#fff; z-index:1000; box-shadow:var(--sombra);
}
.header-inner{
  max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
}
header h1{
  margin:0; font-size:20px; display:flex; align-items:center; gap:10px;
}
#logoHeader{width:40px;height:40px;border-radius:50%;object-fit:cover;}
nav{display:flex; gap:20px; justify-content:center; align-items:center; flex:1;}
nav a{display:inline-block; color:#fff; text-decoration:none; font-weight:bold; padding:8px 12px; border-radius:20px; transition:.2s;}
nav a:hover{background:#fff; color:var(--rosa)}
nav a.ativo{background:#fff; color:var(--rosa)}

main{max-width:1200px; margin:0 auto 24px; padding:100px 16px 24px 16px;}

/* ======= AGENDA ======= */
#agendaMain{display:flex; gap:20px; align-items:flex-start}
#calendario{flex:1; max-height:78vh; overflow-y:auto;}
.mes{background:var(--card); border-radius:14px; padding:12px; margin-bottom:20px; box-shadow:var(--sombra); }
.mes h2{margin:6px 0 12px; text-transform:capitalize; color:var(--rosa-escuro); text-align:center}
.dias-semana{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; text-align:center; font-weight:bold; font-size:12px;}
.dias{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
.dia{background:#ffe6f0; border-radius:8px; min-height:86px; padding:6px; position:relative; font-size:12px;}
.dia-num{font-weight:bold; opacity:.8}
.dia.hoje{outline:2px solid var(--rosa-escuro); background:#ffd1e3}
.badge{display:block; width:100%; text-align:left; border:none; border-radius:8px; color:#fff; padding:6px 8px; margin-top:6px; cursor:pointer; font-size:12px; line-height:1.2; box-shadow:0 2px 6px rgba(0,0,0,.08);}
.badge.avulso{background:var(--azul)}
.badge.pacote{background:var(--verde)}

#sidebar{width:320px; background:var(--card); border-radius:14px; padding:16px; box-shadow:var(--sombra); position:sticky; top:92px;}
#sidebar h3{margin-top:0; color:var(--rosa-escuro); text-align:center}
.field{margin-bottom:10px}
.field label{display:block; font-size:13px; margin-bottom:4px}
.field input, .field select, .field textarea{width:100%; padding:10px; border:2px solid var(--rosa); border-radius:10px; background:#fff;}
textarea{resize:vertical; min-height:60px;}
.btn{display:inline-block; width:100%; border:none; border-radius:10px; padding:10px 12px; font-weight:bold; cursor:pointer; transition:.2s; box-shadow:var(--sombra);}
.btn:hover{transform:translateY(-1px)}
.btn-avulso{background:var(--azul); color:#fff}

/* ======= TUTORES ======= */
#tutoresSec{display:none; display:grid; grid-template-columns:1fr; gap:20px;}
#formTutor, #formAnimal, #listaTutores{background:var(--card); padding:16px; border-radius:14px; box-shadow:var(--sombra);}
#listaTutores h3{margin-top:0; color:var(--rosa-escuro);}
.tutor-card{border-bottom:1px solid #eee; padding:10px 0; display:flex; flex-direction:column; gap:6px;}
.tutor-card span{font-size:14px;}
.animal{display:flex; align-items:center; gap:10px; margin-top:6px; justify-content:space-between;}
.animal img{width:50px; height:50px; border-radius:50%; object-fit:cover;}
.edit-icon{cursor:pointer; color:var(--rosa-escuro); margin-left:6px;}
.edit-icon:hover{color:var(--rosa);}

/* ======= LOGIN ======= */
#loginScreen{position:fixed; inset:0; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000;}
#loginScreen h2{margin-bottom:14px; color:var(--rosa-escuro);}
#loginScreen input{width:260px; padding:10px; margin:6px 0; border:2px solid var(--rosa); border-radius:10px;}
#loginScreen button{width:100%; max-width:280px; padding:10px; margin-top:10px; background:var(--rosa); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;}
#loginScreen #logoLogin{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;}
#loginActions{display:flex; flex-direction:column; gap:8px; width:100%; align-items:center;}
#loginSmall{margin-top:6px; font-size:12px; opacity:.8; text-align:center;}

/* ======= MODAL ======= */
#modalOverlay, #modalOverlayEdit{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000;}
#modal, #modalEdit{background:#fff; width:95%; max-width:420px; border-radius:14px; box-shadow:var(--sombra); padding:16px;}
#modal h3, #modalEdit h3{margin:0 0 8px; color:var(--rosa-escuro); text-align:center;}
.modal-row{display:flex; gap:10px; margin:8px 0;}
.modal-row > *{flex:1;}
.modal-actions{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;}
.btn-danger{background:#dc3545; color:#fff;}
.btn-secondary{background:#6c757d; color:#fff;}
.small{font-size:12px; opacity:.8; margin-top:-4px; text-align:center;}

/* ======= FOOTER ======= */
footer{background:var(--rosa); color:#fff; text-align:center; padding:10px; position:fixed; bottom:0; left:0; right:0; font-size:13px;}
</style>

<!-- Firebase (compat builds para usar firebase.firestore()/auth()) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
</head>
<body>

<div id="loginScreen">
  <img src="logo.png" alt="Logo" id="logoLogin">
  <h2>Login Estética Animal</h2>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPass" placeholder="Senha" />
  <div id="loginActions">
    <button onclick="entrar()">Entrar</button>
    <button onclick="criarConta()">Criar conta</button>
    <button class="btn btn-secondary" style="background:#6c757d" onclick="resetSenha()">Esqueci a senha</button>
  </div>
  <div id="loginSmall">Use email/senha cadastrados. Você pode criar uma conta nova.</div>
</div>

<header>
  <div class="header-inner">
    <h1><img src="logo.png" alt="Logo" id="logoHeader"> Estética Animal</h1>
    <nav>
      <a href="#" id="navAgenda" class="ativo" onclick="mostrarAgenda(event)">Agenda</a>
      <a href="#" id="navTutores" onclick="mostrarTutores(event)">Controle de Tutores</a>
      <a href="#" id="navSair" onclick="sair(event)" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>
</header>

<main>
  <!-- ======= AGENDA ======= -->
  <section id="agendaMain">
    <div id="calendario"></div>
    <aside id="sidebar">
      <h3>Adicionar Banho</h3>
      <div class="field"><label>Tipo</label>
        <select id="tipoBanho" onchange="togglePacoteOptions()">
          <option value="avulso">Avulso</option>
          <option value="pacote">Pacote</option>
        </select>
      </div>
      <div class="field" id="pacoteOptions" style="display:none">
        <label>Pacote</label>
        <select id="pacoteSelecionado">
          <option value="3">Pacote 3 banhos (1x por semana / 3 semanas)</option>
          <option value="4">Pacote 4 banhos (1x por semana / 4 semanas)</option>
        </select>
      </div>
      <div class="field"><label for="tutorSelect">Tutor</label>
        <select id="tutorSelect" onchange="carregarAnimais()">
          <option value="">Selecione um tutor</option>
        </select>
      </div>
      <div class="field"><label for="animalSelect">Cliente</label>
        <select id="animalSelect">
          <option value="">Selecione um cliente</option>
        </select>
      </div>
      <div class="field"><label for="dataBanho">Data</label><input type="date" id="dataBanho" /></div>
      <div class="field"><label for="horario">Horário</label><input type="time" id="horario" /></div>
      <div class="field"><label for="obs">Observações</label><textarea id="obs"></textarea></div>
      <button class="btn btn-avulso" onclick="adicionarBanho()">Adicionar</button>
    </aside>
  </section>

  <!-- ======= CONTROLE DE TUTORES ======= -->
  <section id="tutoresSec">
    <div id="formTutor">
      <h3>Cadastrar Tutor</h3>
      <input type="text" id="tutorNome" placeholder="Nome completo" /><br>
      <input type="text" id="tutorEndereco" placeholder="Endereço" /><br>
      <input type="text" id="tutorTelefone" placeholder="Telefone" /><br>
      <button class="btn btn-avulso" onclick="adicionarTutor()">Salvar Tutor</button>
    </div>
    <div id="formAnimal">
      <h3>Adicionar Cliente</h3>
      <select id="animalTutor"></select><br>
      <input type="text" id="animalNome" placeholder="Nome do Cliente" /><br>
      <input type="file" id="animalFoto" accept="image/*" /><br>
      <button class="btn btn-avulso" onclick="adicionarAnimal()">Salvar Cliente</button>
    </div>
    <div id="listaTutores">
      <h3>Tutores Registrados</h3>
      <div id="tutoresContainer"></div>
    </div>
  </section>
</main>

<!-- ======= MODAL EDIÇÃO BANHO ======= -->
<div id="modalOverlay">
  <div id="modal">
    <h3>Gerenciar Agendamento</h3>
    <div class="small" id="modalInfo"></div>
    <div class="modal-row">
      <div>
        <label>Horário</label>
        <input type="time" id="modalHorario">
      </div>
      <div>
        <label>Aplicar ao pacote?</label>
        <select id="modalAplicarPacote">
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Observações</label>
      <textarea id="modalObs"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-avulso" onclick="salvarEdicaoBanho()">Salvar alterações</button>
      <button class="btn btn-danger" onclick="excluirEsteBanho()">Excluir apenas este</button>
      <button class="btn btn-danger" id="btnExcluirPacote" style="display:none" onclick="excluirPacote()">Excluir pacote inteiro</button>
      <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ======= MODAL EDIÇÃO TUTOR/ANIMAL ======= -->
<div id="modalOverlayEdit">
  <div id="modalEdit">
    <h3 id="modalEditTitle">Editar</h3>
    <div id="modalEditContent"></div>
    <div class="modal-actions">
      <button class="btn btn-avulso" onclick="salvarEdicao()">Salvar</button>
      <button class="btn btn-secondary" onclick="fecharModalEdit()">Cancelar</button>
    </div>
  </div>
</div>

<footer>Versão 3.1 — Produzido por Leocir</footer>

<script>
/* ==================== FIREBASE INIT ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyCcZ-Gt1XqLxRLYI1CnwsqG_2gdyDyHhyI",
  authDomain: "estetica-animal.firebaseapp.com",
  projectId: "estetica-animal",
  storageBucket: "estetica-animal.appspot.com",
  messagingSenderId: "634118247526",
  appId: "1:634118247526:web:1255d3c25f660f66b589a7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ==================== UTIL ==================== */
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
const pad2=n=>String(n).padStart(2,'0');
const toYMD=(y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
function addDaysYMD(ymd, days){
  const [Y,M,D]=ymd.split('-').map(Number);
  const dt=new Date(Y, M-1, D+days);
  return toYMD(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
}

/* ==================== AUTH ==================== */
async function entrar(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{ await auth.signInWithEmailAndPassword(email, pass); }
  catch(e){ alert('Falha no login: '+(e.message||e)); }
}
async function criarConta(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{ await auth.createUserWithEmailAndPassword(email, pass); alert('Conta criada!'); }
  catch(e){ alert('Erro: '+(e.message||e)); }
}
async function resetSenha(){
  const email=document.getElementById('loginEmail').value.trim();
  if(!email){ alert('Informe o email'); return; }
  try{ await auth.sendPasswordResetEmail(email); alert('Email enviado.'); }
  catch(e){ alert('Erro: '+(e.message||e)); }
}
async function sair(e){ if(e) e.preventDefault(); await auth.signOut(); }

auth.onAuthStateChanged(async (user)=>{
  if(user){ document.getElementById('loginScreen').style.display='none'; mostrarAgenda(); await refreshCacheTutores(); await renderCalendario(); }
  else{ document.getElementById('loginScreen').style.display='flex'; }
});
</script>
<script>
/* ==================== NAV ==================== */
function setAtivo(id){document.querySelectorAll('nav a').forEach(a=>a.classList.remove('ativo'));document.getElementById(id).classList.add('ativo');}
function mostrarAgenda(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='flex';document.getElementById('tutoresSec').style.display='none';setAtivo('navAgenda');}
async function mostrarTutores(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='none';document.getElementById('tutoresSec').style.display='grid';setAtivo('navTutores');await listarTutores();}

/* ==================== CALENDARIO ==================== */
let cacheTutores={}, cacheAnimais={}, cacheBanhos=[];
function getTutorNome(id){return cacheTutores[id]?.nome||'Tutor?'}
function getAnimalNome(tutorId, animalId){return cacheAnimais[tutorId]?.find(a=>a.id===animalId)?.nome||'Animal?'}
async function refreshCacheTutores(){
  cacheTutores={}; cacheAnimais={};
  const snap=await db.collection('tutores').get();
  snap.forEach(doc=>{
    cacheTutores[doc.id]=doc.data();
    cacheAnimais[doc.id]=doc.data().animais||[];
  });
}
async function renderCalendario(){
  cacheBanhos=[];
  const snap=await db.collection('banhos').get();
  snap.forEach(doc=>cacheBanhos.push({id:doc.id,...doc.data()}));
  const cont=document.getElementById('calendario'); cont.innerHTML='';
  const hoje=new Date();
  for(let offset=-1; offset<=1; offset++){
    const dt=new Date(hoje.getFullYear(), hoje.getMonth()+offset, 1);
    const y=dt.getFullYear(), m=dt.getMonth();
    const dias=new Date(y,m+1,0).getDate();
    const primeiro=new Date(y,m,1).getDay();
    const mesDiv=document.createElement('div'); mesDiv.className='mes';
    mesDiv.innerHTML=`<h2>${dt.toLocaleDateString('pt-BR',{month:'long', year:'numeric'})}</h2>`;
    mesDiv.innerHTML+=`<div class="dias-semana"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div></div>`;
    const grid=document.createElement('div'); grid.className='dias';
    for(let i=0;i<primeiro;i++) grid.appendChild(document.createElement('div'));
    for(let d=1;d<=dias;d++){
      const dd=document.createElement('div'); dd.className='dia';
      if(d===hoje.getDate()&&m===hoje.getMonth()&&y===hoje.getFullYear()) dd.classList.add('hoje');
      dd.innerHTML=`<div class="dia-num">${d}</div>`;
      const ymd=toYMD(y,m+1,d);
      cacheBanhos.filter(b=>b.data===ymd).sort((a,b)=>a.horario.localeCompare(b.horario)).forEach(b=>{
        const btn=document.createElement('button');
        btn.className='badge '+(b.pacoteId?'pacote':'avulso');
        btn.textContent=`${getAnimalNome(b.tutorId,b.animalId)} — ${b.horario}`;
        btn.title=b.obs||'';
        btn.onclick=()=>abrirModal(b.id);
        dd.appendChild(btn);
      });
      grid.appendChild(dd);
    }
    mesDiv.appendChild(grid); cont.appendChild(mesDiv);
  }
}
function togglePacoteOptions(){document.getElementById('pacoteOptions').style.display=document.getElementById('tipoBanho').value==='pacote'?'block':'none';}
async function carregarAnimais(){
  const tutorId=document.getElementById('tutorSelect').value;
  const sel=document.getElementById('animalSelect'); sel.innerHTML='<option value="">Selecione um cliente</option>';
  if(!tutorId)return;
  (cacheAnimais[tutorId]||[]).forEach(a=>{const op=document.createElement('option'); op.value=a.id; op.textContent=a.nome; sel.appendChild(op);});
}
async function adicionarBanho(){
  const tipo=document.getElementById('tipoBanho').value;
  const tutorId=document.getElementById('tutorSelect').value;
  const animalId=document.getElementById('animalSelect').value;
  const data=document.getElementById('dataBanho').value;
  const horario=document.getElementById('horario').value;
  const obs=document.getElementById('obs').value.trim();
  if(!tutorId||!animalId||!data||!horario){alert('Preencha todos os campos');return;}
  if(tipo==='avulso'){
    await db.collection('banhos').add({tipo,tutorId,animalId,data,horario,obs});
  }else{
    const qtd=parseInt(document.getElementById('pacoteSelecionado').value,10);
    const pacoteId=uid();
    let atual=data;
    for(let i=0;i<qtd;i++){
      await db.collection('banhos').add({tipo,tutorId,animalId,data:atual,horario,pacoteId,obs});
      atual=addDaysYMD(atual,7);
    }
  }
  document.getElementById('obs').value='';
  await renderCalendario();
}

/* ==================== MODAL BANHO ==================== */
let banhoAlvo=null;
function abrirModal(id){
  banhoAlvo=cacheBanhos.find(b=>b.id===id); if(!banhoAlvo) return;
  document.getElementById('modalOverlay').style.display='flex';
  document.getElementById('modalInfo').textContent=`${getTutorNome(banhoAlvo.tutorId)} — ${getAnimalNome(banhoAlvo.tutorId,banhoAlvo.animalId)} (${banhoAlvo.data})`;
  document.getElementById('modalHorario').value=banhoAlvo.horario;
  document.getElementById('modalObs').value=banhoAlvo.obs||'';
  document.getElementById('btnExcluirPacote').style.display=banhoAlvo.pacoteId?'block':'none';
}
function fecharModal(){document.getElementById('modalOverlay').style.display='none';}
async function salvarEdicaoBanho(){
  if(!banhoAlvo)return;
  const novoHorario=document.getElementById('modalHorario').value;
  const novaObs=document.getElementById('modalObs').value.trim();
  if(document.getElementById('modalAplicarPacote').value==='sim' && banhoAlvo.pacoteId){
    const snap=await db.collection('banhos').where('pacoteId','==',banhoAlvo.pacoteId).get();
    const batch=db.batch(); snap.forEach(doc=>batch.update(doc.ref,{horario:novoHorario, obs:novaObs}));
    await batch.commit();
  }else{
    await db.collection('banhos').doc(banhoAlvo.id).update({horario:novoHorario, obs:novaObs});
  }
  fecharModal(); await renderCalendario();
}
async function excluirEsteBanho(){if(!banhoAlvo)return; await db.collection('banhos').doc(banhoAlvo.id).delete(); fecharModal(); await renderCalendario();}
async function excluirPacote(){if(!banhoAlvo||!banhoAlvo.pacoteId)return; const snap=await db.collection('banhos').where('pacoteId','==',banhoAlvo.pacoteId).get(); const batch=db.batch(); snap.forEach(doc=>batch.delete(doc.ref)); await batch.commit(); fecharModal(); await renderCalendario();}

/* ==================== TUTORES ==================== */
async function adicionarTutor(){
  const nome=document.getElementById('tutorNome').value.trim();
  const endereco=document.getElementById('tutorEndereco').value.trim();
  const telefone=document.getElementById('tutorTelefone').value.trim();
  if(!nome){alert('Informe o nome');return;}
  await db.collection('tutores').add({nome,endereco,telefone,animais:[]});
  document.getElementById('tutorNome').value='';
  document.getElementById('tutorEndereco').value='';
  document.getElementById('tutorTelefone').value='';
  await refreshCacheTutores(); await listarTutores();
}
async function adicionarAnimal(){
  const tutorId=document.getElementById('animalTutor').value;
  const nome=document.getElementById('animalNome').value.trim();
  const file=document.getElementById('animalFoto').files[0];
  if(!tutorId||!nome){alert('Preencha os campos');return;}
  let fotoBase64='';
  if(file){
    const reader=new FileReader();
    reader.onload=async e=>{
      fotoBase64=e.target.result;
      await salvarAnimal(tutorId,nome,fotoBase64);
    };
    reader.readAsDataURL(file);
  }else{
    await salvarAnimal(tutorId,nome,fotoBase64);
  }
}
async function salvarAnimal(tutorId,nome,fotoBase64){
  const animal={id:uid(), nome, foto:fotoBase64};
  await db.collection('tutores').doc(tutorId).update({animais:firebase.firestore.FieldValue.arrayUnion(animal)});
  document.getElementById('animalNome').value=''; document.getElementById('animalFoto').value='';
  await refreshCacheTutores(); await listarTutores();
}
async function listarTutores(){
  await refreshCacheTutores();
  const cont=document.getElementById('tutoresContainer'); cont.innerHTML='';
  const selTutor=document.getElementById('tutorSelect'); selTutor.innerHTML='<option value="">Selecione um tutor</option>';
  const selAnimalTutor=document.getElementById('animalTutor'); selAnimalTutor.innerHTML='<option value="">Selecione tutor</option>';
  for(const [id,tutor] of Object.entries(cacheTutores)){
    const card=document.createElement('div'); card.className='tutor-card';
    const span=document.createElement('span'); span.textContent=`${tutor.nome} — ${tutor.telefone} — ${tutor.endereco}`;
    const edit=document.createElement('i'); edit.className='fa fa-pen edit-icon'; edit.onclick=()=>abrirModalEdit('tutor',id);
    span.appendChild(edit); card.appendChild(span);
    (tutor.animais||[]).forEach(a=>{
      const div=document.createElement('div'); div.className='animal';
      const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const img=document.createElement('img'); img.src=a.foto||'https://via.placeholder.com/50';
      left.appendChild(img); const nm=document.createElement('span'); nm.textContent=a.nome; left.appendChild(nm);
      const editA=document.createElement('i'); editA.className='fa fa-pen edit-icon'; editA.onclick=()=>abrirModalEdit('animal',id,a.id);
      div.appendChild(left); div.appendChild(editA); card.appendChild(div);
    });
    cont.appendChild(card);
    const op=document.createElement('option'); op.value=id; op.textContent=tutor.nome; selTutor.appendChild(op);
    const op2=document.createElement('option'); op2.value=id; op2.textContent=tutor.nome; selAnimalTutor.appendChild(op2);
  }
}

/* ==================== MODAL EDIT TUTOR/ANIMAL ==================== */
let editContext=null;
function abrirModalEdit(tipo,tutorId,animalId=null){
  editContext={tipo,tutorId,animalId};
  const cont=document.getElementById('modalEditContent');
  cont.innerHTML='';
  if(tipo==='tutor'){
    const t=cacheTutores[tutorId];
    cont.innerHTML=`<label>Nome</label><input type="text" id="editTutorNome" value="${t.nome}"><br>
                    <label>Endereço</label><input type="text" id="editTutorEndereco" value="${t.endereco||''}"><br>
                    <label>Telefone</label><input type="text" id="editTutorTelefone" value="${t.telefone||''}">`;
    document.getElementById('modalEditTitle').textContent='Editar Tutor';
  }else{
    const a=cacheAnimais[tutorId].find(x=>x.id===animalId);
    cont.innerHTML=`<label>Nome</label><input type="text" id="editAnimalNome" value="${a.nome}"><br>
                    <label>Foto</label><input type="file" id="editAnimalFoto" accept="image/*"><br>
                    <img src="${a.foto||'https://via.placeholder.com/50'}" width="80" style="border-radius:8px;margin-top:6px;">`;
    document.getElementById('modalEditTitle').textContent='Editar Cliente';
  }
  document.getElementById('modalOverlayEdit').style.display='flex';
}
function fecharModalEdit(){document.getElementById('modalOverlayEdit').style.display='none';}
async function salvarEdicao(){
  if(!editContext)return;
  if(editContext.tipo==='tutor'){
    const nome=document.getElementById('editTutorNome').value.trim();
    const endereco=document.getElementById('editTutorEndereco').value.trim();
    const telefone=document.getElementById('editTutorTelefone').value.trim();
    await db.collection('tutores').doc(editContext.tutorId).update({nome,endereco,telefone});
  }else{
    const nome=document.getElementById('editAnimalNome').value.trim();
    const file=document.getElementById('editAnimalFoto').files[0];
    const t=cacheAnimais[editContext.tutorId]; const arr=[...t];
    const idx=arr.findIndex(x=>x.id===editContext.animalId);
    let foto=arr[idx].foto;
    if(file){
      const reader=new FileReader();
      reader.onload=async e=>{
        foto=e.target.result;
        arr[idx]={...arr[idx], nome, foto};
        await db.collection('tutores').doc(editContext.tutorId).update({animais:arr});
        await refreshCacheTutores(); await listarTutores(); fecharModalEdit();
      };
      reader.readAsDataURL(file);
      return;
    }else{
      arr[idx]={...arr[idx], nome, foto};
      await db.collection('tutores').doc(editContext.tutorId).update({animais:arr});
    }
  }
  await refreshCacheTutores(); await listarTutores(); fecharModalEdit();
}
</script>
</body>
</html>
