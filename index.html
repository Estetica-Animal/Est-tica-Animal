<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Estética Animal — Agenda & Tutores</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --rosa:#ff66a3;
  --rosa-escuro:#ff3385;
  --bg:#fff0f6;
  --card:#ffffff;
  --texto:#444;
  --sombra:0 4px 8px rgba(255,102,163,.3);
  --azul:#007bff;
  --verde:#28a745;
  --cinza:#d6d6d6;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--texto); margin:0;}

header{
  position:fixed; top:0; left:0; right:0; background:var(--rosa); color:#fff; z-index:1000; box-shadow:var(--sombra);
}
.header-inner{
  max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
}
header h1{
  margin:0; font-size:20px; display:flex; align-items:center; gap:10px;
}
#logoHeader{width:40px;height:40px;border-radius:50%;object-fit:cover;}
nav{display:flex; gap:20px; justify-content:center; align-items:center; flex:1;}
nav a{display:inline-block; color:#fff; text-decoration:none; font-weight:bold; padding:8px 12px; border-radius:20px; transition:.2s;}
nav a:hover{background:#fff; color:var(--rosa)}
nav a.ativo{background:#fff; color:var(--rosa)}

main{max-width:1200px; margin:0 auto 60px; padding:100px 16px 24px 16px;} /* deixa espaço pro rodapé fixo */

/* ======= AGENDA ======= */
#agendaMain{display:flex; gap:20px; align-items:flex-start}
#calendario{flex:1; max-height:78vh; overflow-y:auto;}
.mes{background:var(--card); border-radius:14px; padding:12px; margin-bottom:20px; box-shadow:var(--sombra); }
.mes h2{margin:6px 0 12px; text-transform:capitalize; color:var(--rosa-escuro); text-align:center}
.dias-semana{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; text-align:center; font-weight:bold; font-size:12px;}
.dias{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
.dia{background:#ffe6f0; border-radius:8px; min-height:86px; padding:6px; position:relative; font-size:12px;}
.dia-num{font-weight:bold; opacity:.8}
.dia.hoje{outline:2px solid var(--rosa-escuro); background:#ffd1e3}
.badge{display:block; width:100%; text-align:left; border:none; border-radius:8px; color:#fff; padding:6px 8px; margin-top:6px; cursor:pointer; font-size:12px; line-height:1.2; box-shadow:0 2px 6px rgba(0,0,0,.08);}
.badge.avulso{background:var(--azul)}
.badge.pacote{background:var(--verde)}

#sidebar{width:320px; background:var(--card); border-radius:14px; padding:16px; box-shadow:var(--sombra); position:sticky; top:92px;}
#sidebar h3{margin-top:0; color:var(--rosa-escuro); text-align:center}
.field{margin-bottom:10px}
.field label{display:block; font-size:13px; margin-bottom:4px}
.field input, .field select, .field textarea{width:100%; padding:10px; border:2px solid var(--rosa); border-radius:10px; background:#fff;}
.field textarea{resize:vertical; min-height:60px;}
.btn{display:inline-block; width:100%; border:none; border-radius:10px; padding:10px 12px; font-weight:bold; cursor:pointer; transition:.2s; box-shadow:var(--sombra);}
.btn:hover{transform:translateY(-1px)}
.btn-avulso{background:var(--azul); color:#fff}

/* ======= TUTORES ======= */
#tutoresSec{display:none; display:grid; grid-template-columns:1fr; gap:20px;}
#formTutor, #formAnimal, #listaTutores{background:var(--card); padding:16px; border-radius:14px; box-shadow:var(--sombra);}
#listaTutores h3{margin-top:0; color:var(--rosa-escuro);}
.tutor-card{border-bottom:1px solid #eee; padding:10px 0; display:flex; flex-direction:column; gap:6px;}
.tutor-card span{font-size:14px;}
.tutor-actions{display:flex; gap:8px; margin-top:6px;}
.tutor-actions i{cursor:pointer;}
.animal{display:flex; align-items:center; gap:10px; margin-top:6px; justify-content:space-between;}
.animal-left{display:flex; align-items:center; gap:10px;}
.animal img{width:40px; height:40px; border-radius:50%; object-fit:cover;}
.edit-icon{cursor:pointer; color:var(--rosa-escuro); margin-left:6px;}
.edit-icon:hover{color:var(--rosa);}

/* ======= LOGIN ======= */
#loginScreen{position:fixed; inset:0; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000;}
#loginScreen h2{margin-bottom:14px; color:var(--rosa-escuro);}
#loginScreen input{width:260px; padding:10px; margin:6px 0; border:2px solid var(--rosa); border-radius:10px;}
#loginScreen button{width:100%; max-width:280px; padding:10px; margin-top:10px; background:var(--rosa); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;}
#loginScreen #logoLogin{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;}
#loginActions{display:flex; flex-direction:column; gap:8px; width:100%; align-items:center;}
#loginSmall{margin-top:6px; font-size:12px; opacity:.8; text-align:center;}

/* ======= MODAL ======= */
#modalOverlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000;}
#modal{background:#fff; width:95%; max-width:460px; border-radius:14px; box-shadow:var(--sombra); padding:16px;}
#modal h3{margin:0 0 8px; color:var(--rosa-escuro); text-align:center;}
.modal-row{display:flex; gap:10px; margin:8px 0;}
.modal-row > *{flex:1;}
.modal-actions{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;}
.btn-danger{background:#dc3545; color:#fff;}
.btn-secondary{background:#6c757d; color:#fff;}
.small{font-size:12px; opacity:.8; margin-top:-4px; text-align:center;}

/* ======= RODAPÉ ======= */
footer{
  position:fixed; left:0; right:0; bottom:0;
  background:#fff; color:#777; border-top:1px solid #eee;
  padding:6px 12px; font-size:12px; text-align:center;
}
footer b{color:#555;}
</style>

<!-- Firebase (compat builds para usar firebase.firestore()/auth()) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
</head>
<body>

<div id="loginScreen">
  <img src="logo.png" alt="Logo" id="logoLogin">
  <h2>Login Estética Animal</h2>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPass" placeholder="Senha" />
  <div id="loginActions">
    <button onclick="entrar()">Entrar</button>
    <button onclick="criarConta()">Criar conta</button>
    <button class="btn btn-secondary" style="background:#6c757d" onclick="resetSenha()">Esqueci a senha</button>
  </div>
  <div id="loginSmall">Use email/senha cadastrados. Você pode criar uma conta nova.</div>
</div>

<header>
  <div class="header-inner">
    <h1><img src="logo.png" alt="Logo" id="logoHeader"> Estética Animal</h1>
    <nav>
      <a href="#" id="navAgenda" class="ativo" onclick="mostrarAgenda(event)">Agenda</a>
      <a href="#" id="navTutores" onclick="mostrarTutores(event)">Controle de Tutores</a>
      <a href="#" id="navSair" onclick="sair(event)" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>
</header>

<main>
  <!-- ======= AGENDA ======= -->
  <section id="agendaMain">
    <div id="calendario"></div>
    <aside id="sidebar">
      <h3>Adicionar Banho</h3>
      <div class="field"><label>Tipo</label>
        <select id="tipoBanho" onchange="togglePacoteOptions()">
          <option value="avulso">Avulso</option>
          <option value="pacote">Pacote</option>
        </select>
      </div>
      <div class="field" id="pacoteOptions" style="display:none">
        <label>Pacote</label>
        <select id="pacoteSelecionado">
          <option value="3">Pacote 3 banhos (1x por semana / 3 semanas)</option>
          <option value="4">Pacote 4 banhos (1x por semana / 4 semanas)</option>
        </select>
      </div>
      <div class="field"><label for="tutorSelect">Tutor</label>
        <select id="tutorSelect" onchange="carregarAnimais()">
          <option value="">Selecione um tutor</option>
        </select>
      </div>
      <div class="field"><label for="animalSelect">Cliente</label>
        <select id="animalSelect">
          <option value="">Selecione um cliente</option>
        </select>
      </div>
      <div class="field"><label for="dataBanho">Data</label><input type="date" id="dataBanho" /></div>
      <div class="field"><label for="horario">Horário</label><input type="time" id="horario" /></div>
      <div class="field"><label for="valor">Valor (opcional)</label><input type="number" id="valor" step="0.01" min="0" /></div>
      <!-- NOVO: OBSERVAÇÕES -->
      <div class="field">
        <label for="obs">Observações (opcional)</label>
        <textarea id="obs" placeholder="Ex.: usar shampoo hipoalergênico, é arisco, etc."></textarea>
      </div>
      <button class="btn btn-avulso" onclick="adicionarBanho()">Adicionar</button>
    </aside>
  </section>

  <!-- ======= CONTROLE DE TUTORES ======= -->
  <section id="tutoresSec">
    <div id="formTutor">
      <h3>Cadastrar Tutor</h3>
      <input type="text" id="tutorNome" placeholder="Nome completo" /><br>
      <input type="text" id="tutorEndereco" placeholder="Endereço" /><br>
      <input type="text" id="tutorTelefone" placeholder="Telefone" /><br>
      <button class="btn btn-avulso" onclick="adicionarTutor()">Salvar Tutor</button>
    </div>
    <div id="formAnimal">
      <h3>Adicionar Cliente</h3>
      <select id="animalTutor"></select><br>
      <input type="text" id="animalNome" placeholder="Nome do Cliente" /><br>
      <input type="file" id="animalFoto" accept="image/*" /><br>
      <button class="btn btn-avulso" onclick="adicionarAnimal()">Salvar Cliente</button>
    </div>
    <div id="listaTutores">
      <h3>Tutores Registrados</h3>
      <div id="tutoresContainer"></div>
    </div>
  </section>
</main>

<!-- ======= MODAL EDIÇÃO AGENDA ======= -->
<div id="modalOverlay">
  <div id="modal">
    <h3>Gerenciar Agendamento</h3>
    <div class="small" id="modalInfo"></div>
    <div class="modal-row">
      <div>
        <label>Horário</label>
        <input type="time" id="modalHorario">
      </div>
      <div>
        <label>Aplicar ao pacote?</label>
        <select id="modalAplicarPacote">
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>
    </div>
    <!-- NOVO: OBSERVAÇÕES NO MODAL -->
    <div class="modal-row">
      <div style="flex:1">
        <label>Observações</label>
        <textarea id="modalObs" placeholder="Observações deste agendamento (opcional)"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-avulso" onclick="salvarEdicaoBanho()">Salvar alterações</button>
      <button class="btn btn-danger" onclick="excluirEsteBanho()">Excluir apenas este</button>
      <button class="btn btn-danger" id="btnExcluirPacote" style="display:none" onclick="excluirPacote()">Excluir pacote inteiro</button>
      <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ======= RODAPÉ ======= -->
<footer>
  <b>v1.0</b> — Produzido por Leocir
</footer>

<script>
/* ==================== FIREBASE INIT ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyCcZ-Gt1XqLxRLYI1CnwsqG_2gdyDyHhyI",
  authDomain: "estetica-animal.firebaseapp.com",
  projectId: "estetica-animal",
  storageBucket: "estetica-animal.appspot.com",
  messagingSenderId: "634118247526",
  appId: "1:634118247526:web:1255d3c25f660f66b589a7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ==================== UTIL / HELPERS ==================== */
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
// datas locais (evita fuso)
const pad2=n=>String(n).padStart(2,'0');
const toYMD=(y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
function addDaysYMD(ymd, days){
  const [Y,M,D]=ymd.split('-').map(Number);
  const dt=new Date(Y, M-1, D+days);
  return toYMD(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
}

/* ==================== AUTH ==================== */
async function entrar(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    alert('Falha no login: '+(e.message||e));
  }
}
async function criarConta(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    alert('Conta criada com sucesso!');
  }catch(e){
    alert('Erro ao criar conta: '+(e.message||e));
  }
}
async function resetSenha(){
  const email=document.getElementById('loginEmail').value.trim();
  if(!email){ alert('Informe o email para recuperar a senha'); return; }
  try{
    await auth.sendPasswordResetEmail(email);
    alert('Email de recuperação enviado.');
  }catch(e){
    alert('Erro ao enviar recuperação: '+(e.message||e));
  }
}
async function sair(e){
  if(e) e.preventDefault();
  await auth.signOut();
}

auth.onAuthStateChanged(async (user)=>{
  if(user){
    document.getElementById('loginScreen').style.display='none';
    mostrarAgenda();
    await refreshCacheTutores();
    await renderCalendario();
  }else{
    document.getElementById('loginScreen').style.display='flex';
  }
});

/* ==================== NAV ==================== */
function setAtivo(id){document.querySelectorAll('nav a').forEach(a=>a.classList.remove('ativo'));document.getElementById(id).classList.add('ativo');}
function mostrarAgenda(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='flex';document.getElementById('tutoresSec').style.display='none';setAtivo('navAgenda');}
async function mostrarTutores(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='none';document.getElementById('tutoresSec').style.display='grid';setAtivo('navTutores');await renderTutores();}

/* ==================== CACHE TUTORES/ANIMAIS ==================== */
let TUTORES_CACHE=[]; // [{id,nome,endereco,tel,animais:[{id,nome,foto}]}]
async function refreshCacheTutores(){
  const tutSnap=await db.collection('tutores').get();
  const arr=[];
  for(const doc of tutSnap.docs){
    const t={id:doc.id, ...doc.data(), animais:[]};
    const aniSnap=await db.collection('tutores').doc(doc.id).collection('animais').get();
    aniSnap.forEach(a=> t.animais.push({id:a.id, ...a.data()}));
    arr.push(t);
  }
  TUTORES_CACHE=arr;
  await atualizarTutoresSelect();
}

/* ==================== CALENDÁRIO ==================== */
async function renderCalendario(){
  const calendario=document.getElementById('calendario');
  calendario.innerHTML='';

  // carrega TODOS os banhos (simples). Em produção: filtrar por intervalo.
  const banhosSnap=await db.collection('banhos').get();
  const banhos=banhosSnap.docs.map(d=>({id:d.id, ...d.data()}));

  const porData=new Map();
  for(const b of banhos){
    if(!porData.has(b.data)) porData.set(b.data,[]);
    porData.get(b.data).push(b);
  }

  const hoje=new Date();
  const baseAno=hoje.getFullYear();
  const baseMes=hoje.getMonth();

  for(let offset=0; offset<2; offset++){
    const primeiroDiaMes=new Date(baseAno, baseMes+offset, 1);
    const ano=primeiroDiaMes.getFullYear();
    const mes=primeiroDiaMes.getMonth();
    const nomeMes=primeiroDiaMes.toLocaleString('pt-BR',{month:'long'});
    const diasNoMes=new Date(ano, mes+1, 0).getDate();

    const mesDiv=document.createElement('div');
    mesDiv.className='mes';
    mesDiv.innerHTML=`<h2>${nomeMes} ${ano}</h2>
      <div class="dias-semana">
        <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
      </div>`;

    const grid=document.createElement('div');
    grid.className='dias';

    // Segunda a domingo
    const inicio=(new Date(ano, mes, 1).getDay()+6)%7;
    for(let i=0;i<inicio;i++) grid.appendChild(document.createElement('div'));

    for(let d=1; d<=diasNoMes; d++){
      const cell=document.createElement('div');
      cell.className='dia';
      if(offset===0 && d===hoje.getDate()) cell.classList.add('hoje');

      const num=document.createElement('div');
      num.className='dia-num';
      num.textContent=d;
      cell.appendChild(num);

      const dayStr=toYMD(ano, mes+1, d);
      const lista=porData.get(dayStr)||[];
      lista.sort((a,b)=> a.horario.localeCompare(b.horario));
      for(const b of lista){
        const btn=document.createElement('button');
        btn.className='badge '+(b.tipo==='pacote'?'pacote':'avulso');

        // Ícone de observação se existir
        const temObs=b.obs && b.obs.trim().length>0;
        const obsIcon = temObs ? ' 💬' : '';

        btn.textContent=`${getAnimalNome(b.tutorId,b.animalId)} — ${b.horario}${obsIcon}`;
        btn.title = temObs ? b.obs : ''; // tooltip com observações
        btn.onclick=()=>abrirModal(b.id);
        cell.appendChild(btn);
      }

      grid.appendChild(cell);
    }

    mesDiv.appendChild(grid);
    calendario.appendChild(mesDiv);
  }
}

/* ==================== TUTORES / CLIENTES ==================== */
async function adicionarTutor(){
  const nome=document.getElementById('tutorNome').value.trim();
  const endereco=document.getElementById('tutorEndereco').value.trim();
  const tel=document.getElementById('tutorTelefone').value.trim();
  if(!nome) return alert('Informe o nome');

  await db.collection('tutores').add({nome,endereco,tel});
  document.getElementById('tutorNome').value='';
  document.getElementById('tutorEndereco').value='';
  document.getElementById('tutorTelefone').value='';
  await refreshCacheTutores();
  await renderTutores();
}

async function adicionarAnimal(){
  const tutorId=document.getElementById('animalTutor').value;
  const nome=document.getElementById('animalNome').value.trim();
  const file=document.getElementById('animalFoto').files[0];
  if(!tutorId) return alert('Selecione um tutor');
  if(!nome) return alert('Informe o nome do cliente');

  let foto='';
  if(file){
    const reader=new FileReader();
    reader.onload=async e=>{
      foto=e.target.result;
      await db.collection('tutores').doc(tutorId).collection('animais').add({nome,foto});
      document.getElementById('animalNome').value='';
      document.getElementById('animalFoto').value='';
      await refreshCacheTutores();
      await renderTutores();
      await atualizarTutoresSelect();
    };
    reader.readAsDataURL(file);
  } else {
    await db.collection('tutores').doc(tutorId).collection('animais').add({nome,foto});
    document.getElementById('animalNome').value='';
    document.getElementById('animalFoto').value='';
    await refreshCacheTutores();
    await renderTutores();
    await atualizarTutoresSelect();
  }
}

async function renderTutores(){
  const container=document.getElementById('tutoresContainer');
  const sel=document.getElementById('animalTutor');
  container.innerHTML='';
  sel.innerHTML='<option value="">Selecione um Tutor</option>';

  for(const t of TUTORES_CACHE){
    sel.innerHTML+=`<option value="${t.id}">${t.nome}</option>`;
    const div=document.createElement('div');
    div.className='tutor-card';
    div.innerHTML=`<strong>${t.nome}</strong><br>${t.endereco||'-'} ${t.tel?(' - '+t.tel):''}`;

    // Ações do tutor: editar e excluir
    const actions=document.createElement('div');
    actions.className='tutor-actions';
    const btnEditTutor=document.createElement('i');
    btnEditTutor.className="fa-solid fa-pen edit-icon";
    btnEditTutor.title='Editar tutor';
    btnEditTutor.onclick=()=>editarTutor(t.id);
    const btnExcluir=document.createElement('i');
    btnExcluir.className="fa-solid fa-trash edit-icon";
    btnExcluir.title='Excluir tutor';
    btnExcluir.onclick=()=>excluirTutor(t.id);
    actions.appendChild(btnEditTutor);
    actions.appendChild(btnExcluir);
    div.appendChild(actions);

    // Animais
    t.animais.forEach(a=>{
      const an=document.createElement('div');
      an.className='animal';
      const left=document.createElement('div');
      left.className='animal-left';
      if(a.foto){ const img=document.createElement('img'); img.src=a.foto; left.appendChild(img); }
      const span=document.createElement('span'); span.textContent=a.nome; left.appendChild(span);
      an.appendChild(left);

      const right=document.createElement('div');
      const editAni=document.createElement('i');
      editAni.className="fa-solid fa-pen edit-icon";
      editAni.title='Editar cliente';
      editAni.onclick=()=>editarAnimal(t.id,a.id);
      const delAni=document.createElement('i');
      delAni.className="fa-solid fa-trash edit-icon";
      delAni.title='Excluir cliente';
      delAni.onclick=()=>excluirAnimal(t.id,a.id);
      right.appendChild(editAni);
      right.appendChild(delAni);

      an.appendChild(right);
      div.appendChild(an);
    });

    container.appendChild(div);
  }
}

async function atualizarTutoresSelect(){
  const sel=document.getElementById('tutorSelect');
  sel.innerHTML='<option value="">Selecione um tutor</option>';
  TUTORES_CACHE.forEach(t=> sel.innerHTML+=`<option value="${t.id}">${t.nome}</option>`);
  await carregarAnimais();
}

async function carregarAnimais(){
  const tutorId=document.getElementById('tutorSelect').value;
  const sel=document.getElementById('animalSelect');
  sel.innerHTML='<option value="">Selecione um cliente</option>';
  const t=TUTORES_CACHE.find(x=>x.id===tutorId);
  if(t) t.animais.forEach(a=> sel.innerHTML+=`<option value="${a.id}">${a.nome}</option>`);
}

function getAnimalNome(tutorId, animalId){
  const t=TUTORES_CACHE.find(x=>x.id===tutorId);
  if(!t) return 'Cliente';
  const a=t.animais.find(x=>x.id===animalId);
  return a? a.nome : 'Cliente';
}

async function excluirTutor(tutorId){
  if(!confirm('Excluir este tutor, clientes e banhos vinculados?')) return;
  // apaga subcoleção animais
  const aniSnap=await db.collection('tutores').doc(tutorId).collection('animais').get();
  const batch=db.batch();
  aniSnap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  // apaga banhos do tutor
  const banhosSnap=await db.collection('banhos').where('tutorId','==',tutorId).get();
  const batch2=db.batch();
  banhosSnap.forEach(doc=> batch2.delete(doc.ref));
  await batch2.commit();

  // apaga tutor
  await db.collection('tutores').doc(tutorId).delete();

  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
  await renderCalendario();
}

async function excluirAnimal(tutorId, animalId){
  if(!confirm('Excluir este cliente e banhos vinculados?')) return;
  await db.collection('tutores').doc(tutorId).collection('animais').doc(animalId).delete();

  // remove banhos deste animal
  const banhosSnap=await db.collection('banhos').where('animalId','==',animalId).get();
  const batch=db.batch();
  banhosSnap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
  await renderCalendario();
}

/* ====== EDITAR TUTOR / ANIMAL ====== */
// Usa prompts simples para edição rápida
async function editarTutor(tutorId){
  const ref=db.collection('tutores').doc(tutorId);
  const snap=await ref.get();
  if(!snap.exists) return;
  const t=snap.data();

  const nome = prompt('Nome do tutor:', t.nome||'');
  if(nome===null) return;
  const endereco = prompt('Endereço:', t.endereco||'');
  if(endereco===null) return;
  const tel = prompt('Telefone:', t.tel||'');
  if(tel===null) return;

  await ref.update({nome:nome.trim(), endereco:endereco.trim(), tel:tel.trim()});
  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
}

async function editarAnimal(tutorId, animalId){
  const ref=db.collection('tutores').doc(tutorId).collection('animais').doc(animalId);
  const snap=await ref.get();
  if(!snap.exists) return;
  const a=snap.data();

  const nome = prompt('Nome do cliente:', a.nome||'');
  if(nome===null) return;

  // Pergunta se deseja trocar a foto
  const trocar = confirm('Deseja atualizar a foto deste cliente?');
  if(trocar){
    // cria um input file temporário
    const fileInput=document.createElement('input');
    fileInput.type='file';
    fileInput.accept='image/*';
    fileInput.onchange=async (ev)=>{
      const file=ev.target.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=async e=>{
          const foto=e.target.result;
          await ref.update({nome:nome.trim(), foto});
          await refreshCacheTutores();
          await renderTutores();
          await atualizarTutoresSelect();
        };
        reader.readAsDataURL(file);
      }else{
        // se não escolheu foto, atualiza só o nome
        await ref.update({nome:nome.trim()});
        await refreshCacheTutores();
        await renderTutores();
        await atualizarTutoresSelect();
      }
    };
    fileInput.click();
  }else{
    await ref.update({nome:nome.trim()});
    await refreshCacheTutores();
    await renderTutores();
    await atualizarTutoresSelect();
  }
}

/* ==================== BANHOS ==================== */
function togglePacoteOptions(){
  const tipo=document.getElementById('tipoBanho').value;
  document.getElementById('pacoteOptions').style.display = (tipo==='pacote') ? 'block' : 'none';
}

async function adicionarBanho(){
  const tipo=document.getElementById('tipoBanho').value;
  const tutorId=document.getElementById('tutorSelect').value;
  const animalId=document.getElementById('animalSelect').value;
  const data=document.getElementById('dataBanho').value; // YYYY-MM-DD
  const horario=document.getElementById('horario').value;
  const valor=document.getElementById('valor').value || '';
  const obs=(document.getElementById('obs').value || '').trim(); // NOVO

  if(!tutorId || !animalId || !data || !horario){
    alert('Preencha tutor, cliente, data e horário.');
    return;
  }

  const pacoteId = (tipo==='pacote') ? uid() : null;

  if(tipo==='avulso'){
    const banho = { tipo, tutorId, animalId, data, horario, valor, pacoteId:null, obs };
    await db.collection('banhos').add(banho);
  } else {
    const qtd=parseInt(document.getElementById('pacoteSelecionado').value,10);
    let atual=data;
    for(let i=0;i<qtd;i++){
      if(i>0) atual = addDaysYMD(atual, 7);
      const banho={ tipo, tutorId, animalId, data:atual, horario, valor, pacoteId, obs };
      await db.collection('banhos').add(banho);
    }
  }

  await renderCalendario();

  // limpa campos
  document.getElementById('tipoBanho').value='avulso';
  togglePacoteOptions();
  document.getElementById('tutorSelect').value='';
  await carregarAnimais();
  document.getElementById('dataBanho').value='';
  document.getElementById('horario').value='';
  document.getElementById('valor').value='';
  document.getElementById('obs').value='';
}

/* ==================== MODAL: editar/excluir ==================== */
let modalBanhoId=null;
async function abrirModal(banhoId){
  modalBanhoId=banhoId;
  const ref=db.collection('banhos').doc(banhoId);
  const b=(await ref.get()).data();
  if(!b) return;

  const info = `${getAnimalNome(b.tutorId,b.animalId)} — ${b.data} às ${b.horario} ${b.tipo==='pacote'?'(pacote)':'(avulso)'}`;
  document.getElementById('modalInfo').textContent=info;
  document.getElementById('modalHorario').value=b.horario;
  document.getElementById('modalAplicarPacote').value='nao';
  document.getElementById('btnExcluirPacote').style.display = (b.pacoteId) ? 'block':'none';
  document.getElementById('modalObs').value = b.obs || ''; // NOVO

  document.getElementById('modalOverlay').style.display='flex';
}
function fecharModal(){
  document.getElementById('modalOverlay').style.display='none';
  modalBanhoId=null;
}
async function salvarEdicaoBanho(){
  const novoHorario=document.getElementById('modalHorario').value;
  const novaObs=(document.getElementById('modalObs').value||'').trim(); // NOVO
  const aplicar=document.getElementById('modalAplicarPacote').value==='sim';
  if(!modalBanhoId || !novoHorario) return;

  const alvoRef=db.collection('banhos').doc(modalBanhoId);
  const alvoSnap=await alvoRef.get();
  const alvo=alvoSnap.data();
  if(!alvo) return;

  if(aplicar && alvo.pacoteId){
    const snap=await db.collection('banhos').where('pacoteId','==',alvo.pacoteId).get();
    const batch=db.batch();
    snap.forEach(doc=> batch.update(doc.ref,{horario:novoHorario, obs:novaObs}));
    await batch.commit();
  }else{
    await alvoRef.update({horario:novoHorario, obs:novaObs});
  }

  fecharModal();
  await renderCalendario();
}
async function excluirEsteBanho(){
  if(!modalBanhoId) return;
  if(!confirm('Deseja excluir apenas este banho?')) return;
  await db.collection('banhos').doc(modalBanhoId).delete();
  fecharModal();
  await renderCalendario();
}
async function excluirPacote(){
  if(!modalBanhoId) return;
  const alvo=await db.collection('banhos').doc(modalBanhoId).get();
  const b=alvo.data();
  if(!b || !b.pacoteId) return;
  if(!confirm('Deseja excluir TODOS os banhos deste pacote?')) return;

  const snap=await db.collection('banhos').where('pacoteId','==',b.pacoteId).get();
  const batch=db.batch();
  snap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  fecharModal();
  await renderCalendario();
}

/* ==================== INICIALIZAÇÃO ==================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  togglePacoteOptions();
  // A UI será liberada após login (onAuthStateChanged).
});
</script>

</body>
</html>
