<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Estética Animal — Agenda & Tutores</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --rosa:#ff66a3;
    --rosa-escuro:#ff3385;
    --bg:#fff0f6;
    --card:#ffffff;
    --texto:#444;
    --sombra:0 4px 8px rgba(255,102,163,.3);
    --azul:#0d6efd;
    --verde:#198754;
  }
  body{font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--texto);}
  header{background:var(--rosa); color:#fff; box-shadow:var(--sombra);}
  header h1{font-size:20px; display:flex; align-items:center; gap:10px; margin:0;}
  #logoHeader{width:40px;height:40px;border-radius:50%;object-fit:cover;}

  .mes{background:var(--card); border-radius:14px; padding:12px; margin-bottom:20px; box-shadow:var(--sombra);}
  .mes h2{margin:6px 0 12px; text-transform:capitalize; color:var(--rosa-escuro); text-align:center}
  .dias-semana{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; text-align:center; font-weight:bold; font-size:12px;}
  .dias{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
  .dia{background:#ffe6f0; border-radius:8px; min-height:86px; padding:6px; font-size:12px;}
  .dia-num{font-weight:bold; opacity:.8}
  .dia.hoje{outline:2px solid var(--rosa-escuro); background:#ffd1e3}
  .badge-ag{display:block; width:100%; text-align:left; border:none; border-radius:8px; color:#fff; padding:6px 8px; margin-top:6px; cursor:pointer; font-size:12px;}
  .badge-ag.avulso{background:var(--azul)}
  .badge-ag.pacote{background:var(--verde)}

  /* Login */
  #loginScreen{position:fixed; inset:0; background:rgba(255,255,255,0.96); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000;}
  #loginScreen h2{margin-bottom:20px; color:var(--rosa-escuro);}
  #loginScreen input{width:220px; padding:10px; margin:6px 0; border:2px solid var(--rosa); border-radius:10px;}
  #loginScreen button{width:100%; max-width:240px; padding:10px; margin-top:12px; background:var(--rosa); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;}
  #loginScreen #logoLogin{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;}

  /* Modal simples */
  #modalOverlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000;}
  #modal{background:#fff; width:95%; max-width:460px; border-radius:14px; box-shadow:var(--sombra); padding:16px;}
  #modal h3{margin:0 0 8px; color:var(--rosa-escuro); text-align:center;}
  .modal-row{display:flex; gap:10px; margin:8px 0;}
  .modal-row > *{flex:1;}
  .modal-actions{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;}

  /* Responsivo: celular = calendário compacto e sidebar abaixo */
  @media (max-width: 768px){
    .dia{min-height:64px; padding:4px; font-size:11px;}
    .dias{gap:4px;}
    .dias-semana{font-size:11px;}
    .mes h2{font-size:16px;}
  }
</style>
</head>
<body>

<!-- Login -->
<div id="loginScreen">
  <img src="logo.png" alt="Logo" id="logoLogin">
  <h2>Login Estética Animal</h2>
  <input type="text" id="loginUser" placeholder="Usuário" />
  <input type="password" id="loginPass" placeholder="Senha" />
  <button onclick="fazerLogin()">Entrar</button>
</div>

<!-- Navbar -->
<header class="py-2">
  <div class="container d-flex justify-content-between align-items-center">
    <h1><img src="logo.png" alt="Logo" id="logoHeader"> Estética Animal</h1>
    <nav class="d-flex gap-2">
      <a href="#" id="navAgenda" class="btn btn-sm btn-light" onclick="mostrarAgenda(event)">Agenda</a>
      <a href="#" id="navTutores" class="btn btn-sm btn-light" onclick="mostrarTutores(event)">Controle de Tutores</a>
    </nav>
  </div>
</header>

<main class="container my-4">
  <!-- ======= AGENDA ======= -->
  <section id="agendaMain" class="row">
    <div class="col-lg-8" id="calendario"></div>
    <aside class="col-lg-4 mt-3 mt-lg-0">
      <div class="card shadow-sm p-3">
        <h3 class="text-center text-primary">Adicionar Banho</h3>
        <div class="mb-2">
          <label>Tipo</label>
          <select id="tipoBanho" class="form-select" onchange="togglePacoteOptions()">
            <option value="avulso">Avulso</option>
            <option value="pacote">Pacote</option>
          </select>
        </div>
        <div class="mb-2" id="pacoteOptions" style="display:none">
          <label>Pacote</label>
          <select id="pacoteSelecionado" class="form-select">
            <option value="3">Pacote 3 banhos (1/semana)</option>
            <option value="4">Pacote 4 banhos (1/semana)</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Tutor</label>
          <select id="tutorSelect" class="form-select" onchange="carregarAnimais()">
            <option value="">Selecione um tutor</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Cliente</label>
          <select id="animalSelect" class="form-select">
            <option value="">Selecione um cliente</option>
          </select>
        </div>
        <div class="mb-2"><label>Data</label><input type="date" id="dataBanho" class="form-control"/></div>
        <div class="mb-2"><label>Horário</label><input type="time" id="horario" class="form-control"/></div>
        <div class="mb-3"><label>Valor (opcional)</label><input type="number" id="valor" class="form-control" step="0.01" min="0"/></div>
        <button class="btn btn-primary w-100" onclick="adicionarBanho()">Adicionar</button>
      </div>
    </aside>
  </section>

  <!-- ======= TUTORES ======= -->
  <section id="tutoresSec" style="display:none">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3 shadow-sm">
          <h3>Cadastrar Tutor</h3>
          <input type="text" id="tutorNome" class="form-control mb-2" placeholder="Nome completo">
          <input type="text" id="tutorEndereco" class="form-control mb-2" placeholder="Endereço">
          <input type="text" id="tutorTelefone" class="form-control mb-2" placeholder="Telefone">
          <button class="btn btn-success w-100" onclick="adicionarTutor()">Salvar Tutor</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 shadow-sm">
          <h3>Adicionar Cliente</h3>
          <select id="animalTutor" class="form-select mb-2"></select>
          <input type="text" id="animalNome" class="form-control mb-2" placeholder="Nome do Cliente">
          <input type="file" id="animalFoto" class="form-control mb-2" accept="image/*">
          <button class="btn btn-info w-100" onclick="adicionarAnimal()">Salvar Cliente</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 shadow-sm">
          <h3>Tutores Registrados</h3>
          <div id="tutoresContainer"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ======= MODAL EDIÇÃO ======= -->
<div id="modalOverlay">
  <div id="modal">
    <h3>Gerenciar Agendamento</h3>
    <div class="small text-center mb-2" id="modalInfo"></div>
    <div class="modal-row">
      <div>
        <label>Horário</label>
        <input type="time" id="modalHorario" class="form-control">
      </div>
      <div>
        <label>Aplicar ao pacote?</label>
        <select id="modalAplicarPacote" class="form-select">
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="salvarEdicaoBanho()">Salvar alterações</button>
      <button class="btn btn-danger" onclick="excluirEsteBanho()">Excluir apenas este</button>
      <button class="btn btn-danger" id="btnExcluirPacote" style="display:none" onclick="excluirPacote()">Excluir pacote inteiro</button>
      <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ==================== APP (Módulo) ==================== -->
<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, deleteDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCcZ-Gt1XqLxRLYI1CnwsqG_2gdyDyHhyI",
  authDomain: "estetica-animal.firebaseapp.com",
  projectId: "estetica-animal",
  storageBucket: "estetica-animal.appspot.com",
  messagingSenderId: "634118247526",
  appId: "1:634118247526:web:1255d3c25f660f66b589a7"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ========= Utils ========= */
const pad2 = n => String(n).padStart(2,'0');
const toYMD = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
function addDaysYMD(ymd, days){
  const [Y,M,D]=ymd.split('-').map(Number);
  const dt=new Date(Y, M-1, D+days); // local (sem UTC) => evita “dia anterior”
  return toYMD(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
}
const uidLocal = () => Date.now().toString(36)+Math.random().toString(36).slice(2,8);

/* ========= Estado / Cache ========= */
let cacheTutores = [];           // [{id, nome, endereco, tel}]
let cacheAnimaisPorTutor = {};   // { [tutorId]: [{id, nome, foto}] }
let mapAnimalNome = new Map();   // animalId -> nome
let modalBanhoId = null;

/* ========= Login ========= */
const usuarios = [
  { user: 'kamilly', pass: 'petshop2025' },
  { user: 'leocir',  pass: 'admin' }
];
window.fazerLogin = function(){
  const u=document.getElementById('loginUser').value.trim().toLowerCase();
  const p=document.getElementById('loginPass').value.trim();
  const ok=usuarios.find(x=>x.user===u && x.pass===p);
  if(ok){
    document.getElementById('loginScreen').style.display='none';
    mostrarAgenda();
    carregarTudo(); // carrega tutores/animais e agenda
  } else {
    alert('Usuário ou senha incorretos');
  }
};

/* ========= Navegação ========= */
window.setAtivo = function(id){
  document.querySelectorAll('header nav a').forEach(a=>a.classList.remove('btn-dark'));
  document.getElementById(id).classList.add('btn-dark');
};
window.mostrarAgenda = function(e){
  if(e) e.preventDefault();
  document.getElementById('agendaMain').style.display='flex';
  document.getElementById('tutoresSec').style.display='none';
  setAtivo('navAgenda');
  renderCalendario();
};
window.mostrarTutores = function(e){
  if(e) e.preventDefault();
  document.getElementById('agendaMain').style.display='none';
  document.getElementById('tutoresSec').style.display='block';
  setAtivo('navTutores');
  renderTutoresUI();
};

/* ========= Firestore: Tutores & Animais ========= */
async function carregarTutoresEAnimais(){
  cacheTutores = [];
  cacheAnimaisPorTutor = {};
  mapAnimalNome.clear();

  const snapT = await getDocs(collection(db,'tutores'));
  snapT.forEach(docu=>{
    cacheTutores.push({ id:docu.id, ...docu.data() });
  });
  // ordena por nome
  cacheTutores.sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));

  // carrega subcoleções de animais
  for(const t of cacheTutores){
    const subSnap = await getDocs(collection(db,'tutores', t.id, 'animais'));
    cacheAnimaisPorTutor[t.id] = [];
    subSnap.forEach(d=>{
      const animal = { id:d.id, ...d.data() };
      cacheAnimaisPorTutor[t.id].push(animal);
      mapAnimalNome.set(animal.id, animal.nome || 'Cliente');
    });
    cacheAnimaisPorTutor[t.id].sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));
  }
}

function renderTutoresUI(){
  // Preenche selects
  const selTutor = document.getElementById('tutorSelect');
  const selTutorAnimal = document.getElementById('animalTutor');
  selTutor.innerHTML = '<option value="">Selecione um tutor</option>';
  selTutorAnimal.innerHTML = '<option value="">Selecione um Tutor</option>';
  cacheTutores.forEach(t=>{
    selTutor.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
    selTutorAnimal.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
  });

  // Lista lateral
  const container = document.getElementById('tutoresContainer');
  container.innerHTML = '';
  cacheTutores.forEach(t=>{
    const card = document.createElement('div');
    card.className = 'border-bottom pb-2 mb-2';
    card.innerHTML = `<strong>${t.nome||'-'}</strong><br>${t.endereco||'-'} ${t.tel?(' - '+t.tel):''}`;

    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-sm btn-outline-danger ms-2';
    btnDel.innerHTML = '<i class="fa-solid fa-trash"></i>';
    btnDel.onclick = ()=> excluirTutor(t.id);

    card.appendChild(btnDel);

    (cacheAnimaisPorTutor[t.id]||[]).forEach(a=>{
      const row = document.createElement('div');
      row.className='d-flex align-items-center justify-content-between mt-2';
      row.innerHTML = `<div class="d-flex align-items-center gap-2">
        ${a.foto?`<img src="${a.foto}" style="width:36px;height:36px;border-radius:50%;object-fit:cover">`:''}
        <span>${a.nome}</span>
      </div>`;
      const btnDelA = document.createElement('button');
      btnDelA.className='btn btn-sm btn-outline-danger';
      btnDelA.innerHTML='<i class="fa-solid fa-trash"></i>';
      btnDelA.onclick=()=> excluirAnimal(t.id, a.id);
      row.appendChild(btnDelA);
      card.appendChild(row);
    });

    container.appendChild(card);
  });
}

window.adicionarTutor = async function(){
  const nome=document.getElementById('tutorNome').value.trim();
  const endereco=document.getElementById('tutorEndereco').value.trim();
  const tel=document.getElementById('tutorTelefone').value.trim();
  if(!nome) return alert('Informe o nome do tutor.');
  await addDoc(collection(db,'tutores'), {nome, endereco, tel});
  document.getElementById('tutorNome').value='';
  document.getElementById('tutorEndereco').value='';
  document.getElementById('tutorTelefone').value='';
  await carregarTutoresEAnimais();
  renderTutoresUI();
  carregarAnimais(); // atualiza select da agenda
};

window.adicionarAnimal = async function(){
  const tutorId=document.getElementById('animalTutor').value;
  const nome=document.getElementById('animalNome').value.trim();
  const file=document.getElementById('animalFoto').files[0];
  if(!tutorId) return alert('Selecione um tutor');
  if(!nome) return alert('Informe o nome do cliente');

  let fotoData = '';
  if(file){
    fotoData = await new Promise((resolve)=>{
      const r=new FileReader();
      r.onload = e=> resolve(e.target.result);
      r.readAsDataURL(file);
    });
  }
  await addDoc(collection(db,'tutores', tutorId, 'animais'), {nome, foto: fotoData});
  document.getElementById('animalNome').value='';
  document.getElementById('animalFoto').value='';
  await carregarTutoresEAnimais();
  renderTutoresUI();
  carregarAnimais(); // atualiza select da agenda
};

async function excluirTutor(tutorId){
  if(!confirm('Excluir este tutor e todos os clientes vinculados?')) return;
  // apaga subcoleção de animais
  const snapAnim = await getDocs(collection(db,'tutores', tutorId, 'animais'));
  for(const a of snapAnim.docs){
    await deleteDoc(doc(db,'tutores', tutorId, 'animais', a.id));
  }
  // apaga o tutor
  await deleteDoc(doc(db,'tutores', tutorId));
  // apaga banhos vinculados ao tutor
  const snapBanhos = await getDocs(collection(db,'banhos'));
  for(const b of snapBanhos.docs){
    if(b.data().tutorId === tutorId){
      await deleteDoc(doc(db,'banhos', b.id));
    }
  }
  await carregarTutoresEAnimais();
  renderTutoresUI();
  renderCalendario();
}

async function excluirAnimal(tutorId, animalId){
  if(!confirm('Excluir este cliente?')) return;
  await deleteDoc(doc(db,'tutores', tutorId, 'animais', animalId));
  // remove banhos deste animal
  const snapBanhos = await getDocs(collection(db,'banhos'));
  for(const b of snapBanhos.docs){
    if(b.data().animalId === animalId){
      await deleteDoc(doc(db,'banhos', b.id));
    }
  }
  await carregarTutoresEAnimais();
  renderTutoresUI();
  carregarAnimais();
  renderCalendario();
}

window.carregarAnimais = function(){
  const tutorId=document.getElementById('tutorSelect').value;
  const sel=document.getElementById('animalSelect');
  sel.innerHTML='<option value="">Selecione um cliente</option>';
  (cacheAnimaisPorTutor[tutorId]||[]).forEach(a=>{
    sel.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
  });
};

/* ========= Firestore: Banhos / Agenda ========= */
function getAnimalNome(animalId){
  return mapAnimalNome.get(animalId) || 'Cliente';
}

window.togglePacoteOptions = function(){
  const tipo=document.getElementById('tipoBanho').value;
  document.getElementById('pacoteOptions').style.display = (tipo==='pacote') ? 'block' : 'none';
};

window.adicionarBanho = async function(){
  const tipo=document.getElementById('tipoBanho').value;
  const tutorId=document.getElementById('tutorSelect').value;
  const animalId=document.getElementById('animalSelect').value;
  const data=document.getElementById('dataBanho').value; // YYYY-MM-DD (string)
  const horario=document.getElementById('horario').value;
  const valor=document.getElementById('valor').value || '';

  if(!tutorId || !animalId || !data || !horario){
    alert('Preencha tutor, cliente, data e horário.');
    return;
  }

  const pacoteId = (tipo==='pacote') ? uidLocal() : null;

  if(tipo==='avulso'){
    await addDoc(collection(db,'banhos'), { tipo, tutorId, animalId, data, horario, valor, pacoteId:null });
  } else {
    const qtd = parseInt(document.getElementById('pacoteSelecionado').value,10);
    let atual = data;
    for(let i=0;i<qtd;i++){
      if(i>0) atual = addDaysYMD(atual, 7); // sempre +7d a partir da string anterior (sem UTC)
      await addDoc(collection(db,'banhos'), { tipo, tutorId, animalId, data:atual, horario, valor, pacoteId });
    }
  }

  // limpar e recarregar
  document.getElementById('tipoBanho').value='avulso';
  togglePacoteOptions();
  document.getElementById('tutorSelect').value='';
  carregarAnimais();
  document.getElementById('dataBanho').value='';
  document.getElementById('horario').value='';
  document.getElementById('valor').value='';

  await renderCalendario();
};

/* ========= Calendário ========= */
async function listarBanhosPeriodo(startYMD, endYMD){
  // Simples: carrega todos e filtra no cliente (evita problemas de índice)
  const snap = await getDocs(collection(db,'banhos'));
  const itens = [];
  snap.forEach(d=>{
    const b = { id:d.id, ...d.data() };
    if(b.data >= startYMD && b.data <= endYMD){
      itens.push(b);
    }
  });
  return itens;
}

window.renderCalendario = async function(){
  const calendario=document.getElementById('calendario');
  calendario.innerHTML='';

  const hoje=new Date();
  const baseAno=hoje.getFullYear();
  const baseMes=hoje.getMonth();

  const mostrarMeses = window.innerWidth < 768 ? 1 : 2;

  // Determina intervalo completo para buscar todos os banhos (ex: 2 meses)
  const start = new Date(baseAno, baseMes, 1);
  const end   = new Date(baseAno, baseMes + (mostrarMeses-1) + 1, 0); // último dia do último mês mostrado
  const startYMD = toYMD(start.getFullYear(), start.getMonth()+1, 1);
  const endYMD   = toYMD(end.getFullYear(),   end.getMonth()+1,   end.getDate());

  const banhosPeriodo = await listarBanhosPeriodo(startYMD, endYMD);
  // indexa por data
  const porData = new Map();
  for(const b of banhosPeriodo){
    if(!porData.has(b.data)) porData.set(b.data, []);
    porData.get(b.data).push(b);
  }

  for(let offset=0; offset<mostrarMeses; offset++){
    const primeiroDiaMes=new Date(baseAno, baseMes+offset, 1);
    const ano=primeiroDiaMes.getFullYear();
    const mes=primeiroDiaMes.getMonth();
    const nomeMes=primeiroDiaMes.toLocaleString('pt-BR',{month:'long'});
    const diasNoMes=new Date(ano, mes+1, 0).getDate();

    const mesDiv=document.createElement('div');
    mesDiv.className='mes';
    mesDiv.innerHTML=`<h2>${nomeMes} ${ano}</h2>
      <div class="dias-semana">
        <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
      </div>`;

    const grid=document.createElement('div');
    grid.className='dias';

    // segunda→domingo (getDay 0=Dom → segunda=0)
    const inicio=(new Date(ano, mes, 1).getDay()+6)%7;
    for(let i=0;i<inicio;i++) grid.appendChild(document.createElement('div'));

    for(let d=1; d<=diasNoMes; d++){
      const cell=document.createElement('div');
      cell.className='dia';
      if(offset===0 && d===hoje.getDate() && mes===hoje.getMonth() && ano===hoje.getFullYear()){
        cell.classList.add('hoje');
      }

      const num=document.createElement('div');
      num.className='dia-num';
      num.textContent=d;
      cell.appendChild(num);

      const dayStr=toYMD(ano, mes+1, d);
      const lista=porData.get(dayStr)||[];
      // ordena por horário simples (HH:MM)
      lista.sort((a,b)=> (a.horario||'').localeCompare(b.horario||''));

      for(const b of lista){
        const btn=document.createElement('button');
        btn.className='badge-ag '+(b.tipo==='pacote'?'pacote':'avulso');
        btn.textContent=`${getAnimalNome(b.animalId)} — ${b.horario}`;
        btn.onclick=()=>abrirModal(b.id);
        cell.appendChild(btn);
      }

      grid.appendChild(cell);
    }

    mesDiv.appendChild(grid);
    calendario.appendChild(mesDiv);
  }
};

/* ========= Modal: editar / excluir ========= */
window.abrirModal = async function(banhoId){
  modalBanhoId = banhoId;
  const bDoc = await getDoc(doc(db,'banhos', banhoId));
  if(!bDoc.exists()) return;
  const b = bDoc.data();
  document.getElementById('modalInfo').textContent =
    `${getAnimalNome(b.animalId)} — ${b.data} às ${b.horario} ${b.tipo==='pacote'?'(pacote)':'(avulso)'}`;
  document.getElementById('modalHorario').value = b.horario || '';
  document.getElementById('modalAplicarPacote').value='nao';
  document.getElementById('btnExcluirPacote').style.display = b.pacoteId ? 'block' : 'none';
  document.getElementById('modalOverlay').style.display='flex';
};
window.fecharModal = function(){
  document.getElementById('modalOverlay').style.display='none';
  modalBanhoId = null;
};
window.salvarEdicaoBanho = async function(){
  const novoHorario = (document.getElementById('modalHorario').value || '').trim();
  const aplicar     = document.getElementById('modalAplicarPacote').value === 'sim';
  if(!modalBanhoId || !novoHorario) return;

  const alvoDoc = await getDoc(doc(db,'banhos', modalBanhoId));
  if(!alvoDoc.exists()) return;
  const alvo = alvoDoc.data();

  if(aplicar && alvo.pacoteId){
    // aplica em todos do pacote
    const snap = await getDocs(collection(db,'banhos'));
    const ops = [];
    for(const d of snap.docs){
      const x = d.data();
      if(x.pacoteId === alvo.pacoteId){
        ops.push(setDoc(doc(db,'banhos', d.id), {...x, horario: novoHorario}));
      }
    }
    await Promise.all(ops);
  } else {
    await setDoc(doc(db,'banhos', modalBanhoId), {...alvo, horario: novoHorario});
  }
  fecharModal();
  await renderCalendario();
};
window.excluirEsteBanho = async function(){
  if(!modalBanhoId) return;
  if(!confirm('Deseja excluir apenas este banho?')) return;
  await deleteDoc(doc(db,'banhos', modalBanhoId));
  fecharModal();
  await renderCalendario();
};
window.excluirPacote = async function(){
  if(!modalBanhoId) return;
  const alvoDoc = await getDoc(doc(db,'banhos', modalBanhoId));
  if(!alvoDoc.exists()) return;
  const alvo = alvoDoc.data();
  if(!alvo.pacoteId) return;
  if(!confirm('Deseja excluir TODOS os banhos deste pacote?')) return;

  const snap = await getDocs(collection(db,'banhos'));
  const ops = [];
  for(const d of snap.docs){
    const x = d.data();
    if(x.pacoteId === alvo.pacoteId){
      ops.push(deleteDoc(doc(db,'banhos', d.id)));
    }
  }
  await Promise.all(ops);
  fecharModal();
  await renderCalendario();
};

/* ========= Carregamento inicial ========= */
async function carregarTudo(){
  await carregarTutoresEAnimais();
  renderTutoresUI();
  carregarAnimais();
  await renderCalendario();
}

// Render inicial básico (antes do login só monta estrutura visual)
document.addEventListener('DOMContentLoaded', ()=>{
  togglePacoteOptions();
  renderCalendario();
});
</script>
</body>
</html>
