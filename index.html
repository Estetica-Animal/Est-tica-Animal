<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Estética Animal — Agenda & Tutores</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --rosa:#ff66a3;
  --rosa-escuro:#ff3385;
  --bg:#fff0f6;
  --card:#ffffff;
  --texto:#444;
  --sombra:0 4px 8px rgba(255,102,163,.3);
  --azul:#007bff;
  --verde:#28a745;
  --cinza:#d6d6d6;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--texto); margin:0;}

header{
  position:fixed; top:0; left:0; right:0; background:var(--rosa); color:#fff; z-index:1000; box-shadow:var(--sombra);
}
.header-inner{
  max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
}
header h1{
  margin:0; font-size:20px; display:flex; align-items:center; gap:10px;
}
#logoHeader{width:40px;height:40px;border-radius:50%;object-fit:cover;}
nav{display:flex; gap:20px; justify-content:center; align-items:center; flex:1;}
nav a{display:inline-block; color:#fff; text-decoration:none; font-weight:bold; padding:8px 12px; border-radius:20px; transition:.2s;}
nav a:hover{background:#fff; color:var(--rosa)}
nav a.ativo{background:#fff; color:var(--rosa)}

main{max-width:1200px; margin:0 auto 80px; padding:100px 16px 24px 16px;} /* espaço pro rodapé */

/* ======= AGENDA ======= */
#agendaMain{display:flex; gap:20px; align-items:flex-start}
#calendario{flex:1; max-height:78vh; overflow-y:auto;}
.mes{background:var(--card); border-radius:14px; padding:12px; margin-bottom:20px; box-shadow:var(--sombra); }
.mes h2{margin:6px 0 12px; text-transform:capitalize; color:var(--rosa-escuro); text-align:center}
.dias-semana{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; text-align:center; font-weight:bold; font-size:12px;}
.dias{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
.dia{background:#ffe6f0; border-radius:8px; min-height:86px; padding:6px; position:relative; font-size:12px;}
.dia-num{font-weight:bold; opacity:.8}
.dia.hoje{outline:2px solid var(--rosa-escuro); background:#ffd1e3}
.badge{display:block; width:100%; text-align:left; border:none; border-radius:8px; color:#fff; padding:6px 8px; margin-top:6px; cursor:pointer; font-size:12px; line-height:1.2; box-shadow:0 2px 6px rgba(0,0,0,.08);}
.badge.avulso{background:var(--azul)}
.badge.pacote{background:var(--verde)}

/* ======= SIDEBAR ======= */
#sidebar{width:320px; background:var(--card); border-radius:14px; padding:16px; box-shadow:var(--sombra); position:sticky; top:92px;}
#sidebar h3{margin-top:0; color:var(--rosa-escuro); text-align:center}
.field{margin-bottom:10px}
.field label{display:block; font-size:13px; margin-bottom:4px}
.field input, .field select, .field textarea{width:100%; padding:10px; border:2px solid var(--rosa); border-radius:10px; background:#fff; font-family:inherit;}
.field textarea{min-height:70px; resize:vertical;}
.btn{display:inline-block; width:100%; border:none; border-radius:10px; padding:10px 12px; font-weight:bold; cursor:pointer; transition:.2s; box-shadow:var(--sombra);}
.btn:hover{transform:translateY(-1px)}
.btn-avulso{background:var(--azul); color:#fff}

/* ======= TUTORES ======= */
#tutoresSec{display:none; display:grid; grid-template-columns:1fr; gap:20px;}
#formTutor, #formAnimal, #listaTutores{background:var(--card); padding:16px; border-radius:14px; box-shadow:var(--sombra);}
#listaTutores h3{margin-top:0; color:var(--rosa-escuro);}
.tutor-card{border-bottom:1px solid #eee; padding:10px 0; display:flex; flex-direction:column; gap:6px;}
.tutor-header{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.tutor-actions{display:flex; gap:10px; align-items:center;}
.tutor-card span{font-size:14px;}
.animal{display:flex; align-items:center; gap:10px; margin-top:6px; justify-content:space-between;}
.animal-left{display:flex; align-items:center; gap:10px;}
.animal img{width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.08);}
.icon-btn{cursor:pointer; color:var(--rosa-escuro);}
.icon-btn:hover{color:var(--rosa);}
.link-foto{font-size:12px; color:#0d6efd; text-decoration:underline; cursor:pointer}

/* ======= LOGIN ======= */
#loginScreen{position:fixed; inset:0; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000;}
#loginScreen h2{margin-bottom:14px; color:var(--rosa-escuro);}
#loginScreen input{width:260px; padding:10px; margin:6px 0; border:2px solid var(--rosa); border-radius:10px;}
#loginScreen button{width:100%; max-width:280px; padding:10px; margin-top:10px; background:var(--rosa); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer;}
#loginScreen #logoLogin{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;}
#loginActions{display:flex; flex-direction:column; gap:8px; width:100%; align-items:center;}
#loginSmall{margin-top:6px; font-size:12px; opacity:.8; text-align:center;}

/* ======= MODAIS ======= */
.modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:4000;}
.modal{background:#fff; width:95%; max-width:480px; border-radius:14px; box-shadow:var(--sombra); padding:16px;}
.modal h3{margin:0 0 8px; color:var(--rosa-escuro); text-align:center;}
.modal-row{display:flex; gap:10px; margin:8px 0;}
.modal-row > *{flex:1;}
.modal-actions{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;}
.btn-danger{background:#dc3545; color:#fff;}
.btn-secondary{background:#6c757d; color:#fff;}
.small{font-size:12px; opacity:.8; margin-top:-4px; text-align:center;}
.preview{width:64px; height:64px; border-radius:12px; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.1);}

/* ======= RODAPÉ ======= */
footer{
  position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #eee; padding:8px 12px;
  display:flex; align-items:center; justify-content:center; gap:8px; color:#777; font-size:12px; z-index:999;
}
footer .dot{width:4px;height:4px;border-radius:50%;background:#ccc;display:inline-block;}
footer strong{color:#555;}
</style>

<!-- Firebase (compat builds) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
</head>
<body>

<div id="loginScreen">
  <img src="logo.png" alt="Logo" id="logoLogin">
  <h2>Login Estética Animal</h2>
  <input type="email" id="loginEmail" placeholder="Email" />
  <input type="password" id="loginPass" placeholder="Senha" />
  <div id="loginActions">
    <button onclick="entrar()">Entrar</button>
    <button onclick="criarConta()">Criar conta</button>
    <button class="btn btn-secondary" style="background:#6c757d" onclick="resetSenha()">Esqueci a senha</button>
  </div>
  <div id="loginSmall">Use email/senha cadastrados. Você pode criar uma conta nova.</div>
</div>

<header>
  <div class="header-inner">
    <h1><img src="logo.png" alt="Logo" id="logoHeader"> Estética Animal</h1>
    <nav>
      <a href="#" id="navAgenda" class="ativo" onclick="mostrarAgenda(event)">Agenda</a>
      <a href="#" id="navTutores" onclick="mostrarTutores(event)">Controle de Tutores</a>
      <a href="#" id="navSair" onclick="sair(event)" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>
</header>

<main>
  <!-- ======= AGENDA ======= -->
  <section id="agendaMain">
    <div id="calendario"></div>
    <aside id="sidebar">
      <h3>Adicionar Banho</h3>
      <div class="field"><label>Tipo</label>
        <select id="tipoBanho" onchange="togglePacoteOptions()">
          <option value="avulso">Avulso</option>
          <option value="pacote">Pacote</option>
        </select>
      </div>
      <div class="field" id="pacoteOptions" style="display:none">
        <label>Pacote</label>
        <select id="pacoteSelecionado">
          <option value="3">Pacote 3 banhos (1x por semana / 3 semanas)</option>
          <option value="4">Pacote 4 banhos (1x por semana / 4 semanas)</option>
        </select>
      </div>
      <div class="field"><label for="tutorSelect">Tutor</label>
        <select id="tutorSelect" onchange="carregarAnimais()">
          <option value="">Selecione um tutor</option>
        </select>
      </div>
      <div class="field"><label for="animalSelect">Cliente</label>
        <select id="animalSelect">
          <option value="">Selecione um cliente</option>
        </select>
      </div>
      <div class="field"><label for="dataBanho">Data</label><input type="date" id="dataBanho" /></div>
      <div class="field"><label for="horario">Horário</label><input type="time" id="horario" /></div>
      <div class="field"><label for="obs">Observações (opcional)</label>
        <textarea id="obs" placeholder="Ex.: usar shampoo hipoalergênico, tosar patinhas, cliente nervoso, etc."></textarea>
      </div>
      <button class="btn btn-avulso" onclick="adicionarBanho()">Adicionar</button>
    </aside>
  </section>

  <!-- ======= CONTROLE DE TUTORES ======= -->
  <section id="tutoresSec">
    <div id="formTutor">
      <h3>Cadastrar Tutor</h3>
      <input type="text" id="tutorNome" placeholder="Nome completo" /><br>
      <input type="text" id="tutorEndereco" placeholder="Endereço" /><br>
      <input type="text" id="tutorTelefone" placeholder="Telefone" /><br>
      <button class="btn btn-avulso" onclick="adicionarTutor()">Salvar Tutor</button>
    </div>
    <div id="formAnimal">
      <h3>Adicionar Cliente</h3>
      <select id="animalTutor"></select><br>
      <input type="text" id="animalNome" placeholder="Nome do Cliente" /><br>
      <input type="file" id="animalFoto" accept="image/*" /><br>
      <button class="btn btn-avulso" id="btnSalvarAnimal" onclick="adicionarAnimal()">Salvar Cliente</button>
      <div id="ajudaUpload" class="small" style="display:none">Enviando foto… aguarde.</div>
    </div>
    <div id="listaTutores">
      <h3>Tutores Registrados</h3>
      <div id="tutoresContainer"></div>
    </div>
  </section>
</main>

<!-- ======= MODAL EDIÇÃO DE BANHO ======= -->
<div id="modalBanhoOverlay" class="modal-overlay">
  <div class="modal" id="modalBanho">
    <h3>Gerenciar Agendamento</h3>
    <div class="small" id="modalInfo"></div>
    <div class="modal-row">
      <div>
        <label>Horário</label>
        <input type="time" id="modalHorario">
      </div>
      <div>
        <label>Aplicar ao pacote?</label>
        <select id="modalAplicarPacote">
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label for="modalObs">Observações (opcional)</label>
      <textarea id="modalObs" placeholder="Notas deste atendimento"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-avulso" onclick="salvarEdicaoBanho()">Salvar alterações</button>
      <button class="btn btn-danger" onclick="excluirEsteBanho()">Excluir apenas este</button>
      <button class="btn btn-danger" id="btnExcluirPacote" style="display:none" onclick="excluirPacote()">Excluir pacote inteiro</button>
      <button class="btn btn-secondary" onclick="fecharModalBanho()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ======= MODAL EDIÇÃO DE TUTOR ======= -->
<div id="modalTutorOverlay" class="modal-overlay">
  <div class="modal" id="modalTutor">
    <h3>Editar Tutor</h3>
    <div class="field">
      <label>Nome</label>
      <input type="text" id="editTutorNome">
    </div>
    <div class="field">
      <label>Endereço</label>
      <input type="text" id="editTutorEndereco">
    </div>
    <div class="field">
      <label>Telefone</label>
      <input type="text" id="editTutorTelefone">
    </div>
    <div class="modal-actions">
      <button class="btn btn-avulso" onclick="salvarEdicaoTutor()">Salvar</button>
      <button class="btn btn-secondary" onclick="fecharModalTutor()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ======= MODAL EDIÇÃO DE ANIMAL ======= -->
<div id="modalAnimalOverlay" class="modal-overlay">
  <div class="modal" id="modalAnimal">
    <h3>Editar Cliente</h3>
    <div class="field">
      <label>Nome do Cliente</label>
      <input type="text" id="editAnimalNome">
    </div>
    <div class="field">
      <label>Foto (opcional)</label>
      <div class="modal-row" style="align-items:center;">
        <img id="editAnimalPreview" class="preview" alt="Prévia" style="display:none">
        <input type="file" id="editAnimalFoto" accept="image/*" onchange="previewEditAnimalFoto(event)">
      </div>
      <div id="editAnimalLinkWrap" class="small" style="display:none">
        <a id="editAnimalLink" href="#" target="_blank" class="link-foto">Abrir foto atual</a>
      </div>
      <div id="editUploadHint" class="small" style="display:none">Enviando nova foto…</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-avulso" id="btnSalvarAnimalEdit" onclick="salvarEdicaoAnimal()">Salvar</button>
      <button class="btn btn-secondary" onclick="fecharModalAnimal()">Cancelar</button>
    </div>
  </div>
</div>

<footer>
  <span>Estética Animal</span>
  <span class="dot"></span>
  <span>Versão <strong>3.3.1</strong></span>
  <span class="dot"></span>
  <span>Produzido por <strong>Leocir</strong></span>
</footer>

<script>
/* ==================== FIREBASE INIT ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyCcZ-Gt1XqLxRLYI1CnwsqG_2gdyDyHhyI",
  authDomain: "estetica-animal.firebaseapp.com",
  projectId: "estetica-animal",
  storageBucket: "estetica-animal.appspot.com",
  messagingSenderId: "634118247526",
  appId: "1:634118247526:web:1255d3c25f660f66b589a7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

/* ==================== UTIL / HELPERS ==================== */
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
const pad2=n=>String(n).padStart(2,'0');
const toYMD=(y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
function addDaysYMD(ymd, days){
  const [Y,M,D]=ymd.split('-').map(Number);
  const dt=new Date(Y, M-1, D+days);
  return toYMD(dt.getFullYear(), dt.getMonth()+1, dt.getDate());
}
function fileExt(file){
  const n=file?.name||"";
  const i=n.lastIndexOf(".");
  return (i>=0? n.slice(i+1).toLowerCase() : "jpg").replace(/[^a-z0-9]/gi,"");
}
function isImage(file){
  return !!file && /^image\//.test(file.type || "");
}

/* ==================== AUTH ==================== */
async function entrar(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    alert('Falha no login: '+(e.message||e));
  }
}
async function criarConta(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Informe email e senha'); return; }
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    alert('Conta criada com sucesso!');
  }catch(e){
    alert('Erro ao criar conta: '+(e.message||e));
  }
}
async function resetSenha(){
  const email=document.getElementById('loginEmail').value.trim();
  if(!email){ alert('Informe o email para recuperar a senha'); return; }
  try{
    await auth.sendPasswordResetEmail(email);
    alert('Email de recuperação enviado.');
  }catch(e){
    alert('Erro ao enviar recuperação: '+(e.message||e));
  }
}
async function sair(e){
  if(e) e.preventDefault();
  await auth.signOut();
}

auth.onAuthStateChanged(async (user)=>{
  if(user){
    document.getElementById('loginScreen').style.display='none';
    mostrarAgenda();
    await refreshCacheTutores();
    await renderCalendario();
  }else{
    document.getElementById('loginScreen').style.display='flex';
  }
});

/* ==================== NAV ==================== */
function setAtivo(id){document.querySelectorAll('nav a').forEach(a=>a.classList.remove('ativo'));document.getElementById(id).classList.add('ativo');}
function mostrarAgenda(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='flex';document.getElementById('tutoresSec').style.display='none';setAtivo('navAgenda');}
async function mostrarTutores(e){if(e)e.preventDefault();document.getElementById('agendaMain').style.display='none';document.getElementById('tutoresSec').style.display='grid';setAtivo('navTutores');await renderTutores();}

/* ==================== CACHE TUTORES/ANIMAIS ==================== */
let TUTORES_CACHE=[]; // [{id,nome,endereco,tel,animais:[{id,nome,foto}]}]
async function refreshCacheTutores(){
  const tutSnap=await db.collection('tutores').get();
  const arr=[];
  for(const docu of tutSnap.docs){
    const t={id:docu.id, ...docu.data(), animais:[]};
    const aniSnap=await db.collection('tutores').doc(docu.id).collection('animais').get();
    aniSnap.forEach(a=> t.animais.push({id:a.id, ...a.data()}));
    arr.push(t);
  }
  TUTORES_CACHE=arr;
  await atualizarTutoresSelect();
}

/* ==================== CALENDÁRIO ==================== */
async function renderCalendario(){
  const calendario=document.getElementById('calendario');
  calendario.innerHTML='';

  const banhosSnap=await db.collection('banhos').get();
  const banhos=banhosSnap.docs.map(d=>({id:d.id, ...d.data()}));

  const porData=new Map();
  for(const b of banhos){
    if(!porData.has(b.data)) porData.set(b.data,[]);
    porData.get(b.data).push(b);
  }

  const hoje=new Date();
  const baseAno=hoje.getFullYear();
  const baseMes=hoje.getMonth();

  for(let offset=0; offset<2; offset++){
    const primeiroDiaMes=new Date(baseAno, baseMes+offset, 1);
    const ano=primeiroDiaMes.getFullYear();
    const mes=primeiroDiaMes.getMonth();
    const nomeMes=primeiroDiaMes.toLocaleString('pt-BR',{month:'long'});
    const diasNoMes=new Date(ano, mes+1, 0).getDate();

    const mesDiv=document.createElement('div');
    mesDiv.className='mes';
    mesDiv.innerHTML=`<h2>${nomeMes} ${ano}</h2>
      <div class="dias-semana">
        <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
      </div>`;

    const grid=document.createElement('div');
    grid.className='dias';

    // Segunda a domingo
    const inicio=(new Date(ano, mes, 1).getDay()+6)%7;
    for(let i=0;i<inicio;i++) grid.appendChild(document.createElement('div'));

    for(let d=1; d<=diasNoMes; d++){
      const cell=document.createElement('div');
      cell.className='dia';
      if(offset===0 && d===hoje.getDate()) cell.classList.add('hoje');

      const num=document.createElement('div');
      num.className='dia-num';
      num.textContent=d;
      cell.appendChild(num);

      const dayStr=toYMD(ano, mes+1, d);
      const lista=porData.get(dayStr)||[];
      lista.sort((a,b)=> a.horario.localeCompare(b.horario));
      for(const b of lista){
        const btn=document.createElement('button');
        btn.className='badge '+(b.tipo==='pacote'?'pacote':'avulso');
        const nomeAnimal = getAnimalNome(b.tutorId,b.animalId);
        btn.textContent=`${nomeAnimal} — ${b.horario}`;
        if(b.obs && b.obs.trim()){
          btn.title = b.obs;
        }
        btn.onclick=()=>abrirModalBanho(b.id);
        cell.appendChild(btn);
      }

      grid.appendChild(cell);
    }

    mesDiv.appendChild(grid);
    calendario.appendChild(mesDiv);
  }
}

/* ==================== TUTORES / CLIENTES ==================== */
async function adicionarTutor(){
  const nome=document.getElementById('tutorNome').value.trim();
  const endereco=document.getElementById('tutorEndereco').value.trim();
  const tel=document.getElementById('tutorTelefone').value.trim();
  if(!nome) return alert('Informe o nome');

  try{
    await db.collection('tutores').add({nome,endereco,tel});
    document.getElementById('tutorNome').value='';
    document.getElementById('tutorEndereco').value='';
    document.getElementById('tutorTelefone').value='';
    await refreshCacheTutores();
    await renderTutores();
  }catch(e){
    alert('Erro ao salvar tutor: ' + (e.message||e));
  }
}

async function uploadAnimalPhoto(tutorId, animalId, file){
  if(!file) return '';
  if(!isImage(file)) throw new Error('Arquivo selecionado não é uma imagem.');
  if(file.size > 8*1024*1024) throw new Error('Imagem maior que 8MB. Escolha um arquivo menor.');
  const ext=fileExt(file)||'jpg';
  const path=`animais/${tutorId}/${animalId}.${ext}`;
  const ref=storage.ref().child(path);
  const metadata={contentType: file.type || 'image/jpeg', cacheControl: 'public,max-age=31536000'};
  await ref.put(file, metadata);
  const url=await ref.getDownloadURL();
  return url;
}

async function adicionarAnimal(){
  const tutorId=document.getElementById('animalTutor').value;
  const nome=document.getElementById('animalNome').value.trim();
  const file=document.getElementById('animalFoto').files[0];
  const btn=document.getElementById('btnSalvarAnimal');
  const hint=document.getElementById('ajudaUpload');

  if(!tutorId) return alert('Selecione um tutor');
  if(!nome) return alert('Informe o nome do cliente');

  try{
    btn.disabled=true; hint.style.display='block';

    // cria doc com ID conhecido para usar no path da foto
    const docRef=db.collection('tutores').doc(tutorId).collection('animais').doc();
    let fotoURL='';
    if(file){
      fotoURL=await uploadAnimalPhoto(tutorId, docRef.id, file);
    }
    await docRef.set({nome, foto: fotoURL});

    document.getElementById('animalNome').value='';
    document.getElementById('animalFoto').value='';
    await refreshCacheTutores();
    await renderTutores();
    await atualizarTutoresSelect();
  }catch(e){
    alert('Erro ao salvar cliente: ' + (e.message||e));
  }finally{
    btn.disabled=false; hint.style.display='none';
  }
}

async function renderTutores(){
  const container=document.getElementById('tutoresContainer');
  const sel=document.getElementById('animalTutor');
  container.innerHTML='';
  sel.innerHTML='<option value="">Selecione um Tutor</option>';

  for(const t of TUTORES_CACHE){
    sel.innerHTML+=`<option value="${t.id}">${t.nome}</option>`;

    const card=document.createElement('div');
    card.className='tutor-card';

    const header=document.createElement('div');
    header.className='tutor-header';

    const titulo=document.createElement('div');
    titulo.innerHTML=`<strong>${t.nome}</strong><br>${t.endereco||'-'} ${t.tel?(' - '+t.tel):''}`;
    header.appendChild(titulo);

    const actions=document.createElement('div');
    actions.className='tutor-actions';

    const btnEdit=document.createElement('i');
    btnEdit.className="fa-solid fa-pen-to-square icon-btn";
    btnEdit.title='Editar tutor';
    btnEdit.onclick=()=>editarTutor(t.id);
    actions.appendChild(btnEdit);

    const btnExcluir=document.createElement('i');
    btnExcluir.className="fa-solid fa-trash icon-btn";
    btnExcluir.title='Excluir tutor';
    btnExcluir.onclick=()=>excluirTutor(t.id);
    actions.appendChild(btnExcluir);

    header.appendChild(actions);
    card.appendChild(header);

    t.animais.forEach(a=>{
      const line=document.createElement('div');
      line.className='animal';

      const left=document.createElement('div');
      left.className='animal-left';
      if(a.foto){
        const img=document.createElement('img');
        img.src=a.foto;
        img.alt=a.nome;
        img.title='Abrir foto';
        img.style.cursor='pointer';
        img.onclick=()=>window.open(a.foto, '_blank');
        left.appendChild(img);
      } else {
        const placeholder=document.createElement('div');
        placeholder.style.width='40px'; placeholder.style.height='40px';
        placeholder.style.borderRadius='50%'; placeholder.style.background='#f3f3f3'; placeholder.style.border='2px solid #fff';
        left.appendChild(placeholder);
      }
      const span=document.createElement('span');
      span.textContent=a.nome;
      left.appendChild(span);

      const right=document.createElement('div');
      right.style.display='flex'; right.style.gap='10px';

      const editAni=document.createElement('i');
      editAni.className="fa-solid fa-pen-to-square icon-btn";
      editAni.title='Editar cliente';
      editAni.onclick=()=>editarAnimal(t.id,a.id);
      right.appendChild(editAni);

      const delAni=document.createElement('i');
      delAni.className="fa-solid fa-trash icon-btn";
      delAni.title='Excluir cliente';
      delAni.onclick=()=>excluirAnimal(t.id,a.id);
      right.appendChild(delAni);

      line.appendChild(left);
      line.appendChild(right);
      card.appendChild(line);
    });

    container.appendChild(card);
  }
}

async function atualizarTutoresSelect(){
  const sel=document.getElementById('tutorSelect');
  sel.innerHTML='<option value="">Selecione um tutor</option>';
  TUTORES_CACHE.forEach(t=> sel.innerHTML+=`<option value="${t.id}">${t.nome}</option>`);
  await carregarAnimais();
}
async function carregarAnimais(){
  const tutorId=document.getElementById('tutorSelect').value;
  const sel=document.getElementById('animalSelect');
  sel.innerHTML='<option value="">Selecione um cliente</option>';
  const t=TUTORES_CACHE.find(x=>x.id===tutorId);
  if(t) t.animais.forEach(a=> sel.innerHTML+=`<option value="${a.id}">${a.nome}</option>`);
}
function getAnimalNome(tutorId, animalId){
  const t=TUTORES_CACHE.find(x=>x.id===tutorId);
  if(!t) return 'Cliente';
  const a=t.animais.find(x=>x.id===animalId);
  return a? a.nome : 'Cliente';
}
async function excluirTutor(tutorId){
  if(!confirm('Excluir este tutor, clientes e banhos vinculados?')) return;
  // apaga subcoleção animais
  const aniSnap=await db.collection('tutores').doc(tutorId).collection('animais').get();
  const batch=db.batch();
  aniSnap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  // apaga banhos do tutor
  const banhosSnap=await db.collection('banhos').where('tutorId','==',tutorId).get();
  const batch2=db.batch();
  banhosSnap.forEach(doc=> batch2.delete(doc.ref));
  await batch2.commit();

  // apaga tutor
  await db.collection('tutores').doc(tutorId).delete();

  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
  await renderCalendario();
}
async function excluirAnimal(tutorId, animalId){
  if(!confirm('Excluir este cliente e banhos vinculados?')) return;
  await db.collection('tutores').doc(tutorId).collection('animais').doc(animalId).delete();

  // remove banhos deste animal
  const banhosSnap=await db.collection('banhos').where('animalId','==',animalId).get();
  const batch=db.batch();
  banhosSnap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
  await renderCalendario();
}

/* ======= EDIÇÃO: TUTOR ======= */
let EDIT_TUTOR_ID=null;
async function editarTutor(tutorId){
  EDIT_TUTOR_ID=tutorId;
  const snap=await db.collection('tutores').doc(tutorId).get();
  const t=snap.data();
  if(!t) return;
  document.getElementById('editTutorNome').value = t.nome||'';
  document.getElementById('editTutorEndereco').value = t.endereco||'';
  document.getElementById('editTutorTelefone').value = t.tel||'';
  document.getElementById('modalTutorOverlay').style.display='flex';
}
function fecharModalTutor(){
  document.getElementById('modalTutorOverlay').style.display='none';
  EDIT_TUTOR_ID=null;
}
async function salvarEdicaoTutor(){
  if(!EDIT_TUTOR_ID) return;
  const nome=document.getElementById('editTutorNome').value.trim();
  const endereco=document.getElementById('editTutorEndereco').value.trim();
  const tel=document.getElementById('editTutorTelefone').value.trim();
  if(!nome){ alert('Informe o nome'); return; }
  await db.collection('tutores').doc(EDIT_TUTOR_ID).update({nome,endereco,tel});
  fecharModalTutor();
  await refreshCacheTutores();
  await renderTutores();
  await atualizarTutoresSelect();
}

/* ======= EDIÇÃO: ANIMAL ======= */
let EDIT_ANIMAL_TUTOR_ID=null;
let EDIT_ANIMAL_ID=null;
let EDIT_ANIMAL_FILE=null; // arquivo novo (File), não base64
async function editarAnimal(tutorId, animalId){
  EDIT_ANIMAL_TUTOR_ID=tutorId;
  EDIT_ANIMAL_ID=animalId;
  EDIT_ANIMAL_FILE=null;

  const snap=await db.collection('tutores').doc(tutorId).collection('animais').doc(animalId).get();
  const a=snap.data();
  if(!a) return;
  document.getElementById('editAnimalNome').value = a.nome || '';

  const prev=document.getElementById('editAnimalPreview');
  const linkWrap=document.getElementById('editAnimalLinkWrap');
  const link=document.getElementById('editAnimalLink');

  if(a.foto){
    prev.src = a.foto;
    prev.style.display='block';
    link.href=a.foto; linkWrap.style.display='block';
  }else{
    prev.src=''; prev.style.display='none';
    linkWrap.style.display='none';
  }
  document.getElementById('editAnimalFoto').value='';
  document.getElementById('modalAnimalOverlay').style.display='flex';
}
function previewEditAnimalFoto(ev){
  const file=ev.target.files && ev.target.files[0];
  if(!file){ EDIT_ANIMAL_FILE=null; return; }
  EDIT_ANIMAL_FILE=file;
  const prev=document.getElementById('editAnimalPreview');
  prev.src = URL.createObjectURL(file);
  prev.style.display='block';
}
function fecharModalAnimal(){
  document.getElementById('modalAnimalOverlay').style.display='none';
  EDIT_ANIMAL_TUTOR_ID=null;
  EDIT_ANIMAL_ID=null;
  EDIT_ANIMAL_FILE=null;
}
async function salvarEdicaoAnimal(){
  if(!EDIT_ANIMAL_TUTOR_ID || !EDIT_ANIMAL_ID) return;
  const nome=document.getElementById('editAnimalNome').value.trim();
  const payload={ nome };
  const btn=document.getElementById('btnSalvarAnimalEdit');
  const hint=document.getElementById('editUploadHint');
  try{
    btn.disabled=true; hint.style.display='block';
    if(EDIT_ANIMAL_FILE){
      const url=await uploadAnimalPhoto(EDIT_ANIMAL_TUTOR_ID, EDIT_ANIMAL_ID, EDIT_ANIMAL_FILE);
      payload.foto=url;
    }
    await db.collection('tutores').doc(EDIT_ANIMAL_TUTOR_ID).collection('animais').doc(EDIT_ANIMAL_ID).update(payload);
    fecharModalAnimal();
    await refreshCacheTutores();
    await renderTutores();
    await atualizarTutoresSelect();
    await renderCalendario();
  }catch(e){
    alert('Erro ao salvar cliente: ' + (e.message||e));
  }finally{
    btn.disabled=false; hint.style.display='none';
  }
}

/* ==================== BANHOS ==================== */
function togglePacoteOptions(){
  const tipo=document.getElementById('tipoBanho').value;
  document.getElementById('pacoteOptions').style.display = (tipo==='pacote') ? 'block' : 'none';
}

async function adicionarBanho(){
  const tipo=document.getElementById('tipoBanho').value;
  const tutorId=document.getElementById('tutorSelect').value;
  const animalId=document.getElementById('animalSelect').value;
  const data=document.getElementById('dataBanho').value; // YYYY-MM-DD
  const horario=document.getElementById('horario').value;
  const obs=document.getElementById('obs').value || '';

  if(!tutorId || !animalId || !data || !horario){
    alert('Preencha tutor, cliente, data e horário.');
    return;
  }

  const pacoteId = (tipo==='pacote') ? uid() : null;

  try{
    if(tipo==='avulso'){
      const banho = { tipo, tutorId, animalId, data, horario, obs, pacoteId:null };
      await db.collection('banhos').add(banho);
    } else {
      const qtd=parseInt(document.getElementById('pacoteSelecionado').value,10);
      let atual=data;
      for(let i=0;i<qtd;i++){
        if(i>0) atual = addDaysYMD(atual, 7);
        const banho={ tipo, tutorId, animalId, data:atual, horario, obs, pacoteId };
        await db.collection('banhos').add(banho);
      }
    }
    await renderCalendario();

    // limpa campos
    document.getElementById('tipoBanho').value='avulso';
    togglePacoteOptions();
    document.getElementById('tutorSelect').value='';
    await carregarAnimais();
    document.getElementById('dataBanho').value='';
    document.getElementById('horario').value='';
    document.getElementById('obs').value='';
  }catch(e){
    alert('Erro ao salvar agendamento: ' + (e.message||e));
  }
}

/* ==================== MODAL: editar/excluir BANHO ==================== */
let modalBanhoId=null;
async function abrirModalBanho(banhoId){
  modalBanhoId=banhoId;
  const ref=db.collection('banhos').doc(banhoId);
  const b=(await ref.get()).data();
  if(!b) return;

  const info = `${getAnimalNome(b.tutorId,b.animalId)} — ${b.data} às ${b.horario} ${b.tipo==='pacote'?'(pacote)':'(avulso)'}`;
  document.getElementById('modalInfo').textContent=info;
  document.getElementById('modalHorario').value=b.horario;
  document.getElementById('modalObs').value=b.obs||'';
  document.getElementById('modalAplicarPacote').value='nao';
  document.getElementById('btnExcluirPacote').style.display = (b.pacoteId) ? 'block':'none';

  document.getElementById('modalBanhoOverlay').style.display='flex';
}
function fecharModalBanho(){
  document.getElementById('modalBanhoOverlay').style.display='none';
  modalBanhoId=null;
}
async function salvarEdicaoBanho(){
  const novoHorario=document.getElementById('modalHorario').value;
  const novasObs=(document.getElementById('modalObs').value||'');
  const aplicar=document.getElementById('modalAplicarPacote').value==='sim';
  if(!modalBanhoId || !novoHorario) return;

  const alvoRef=db.collection('banhos').doc(modalBanhoId);
  const alvoSnap=await alvoRef.get();
  const alvo=alvoSnap.data();
  if(!alvo) return;

  if(aplicar && alvo.pacoteId){
    const snap=await db.collection('banhos').where('pacoteId','==',alvo.pacoteId).get();
    const batch=db.batch();
    snap.forEach(doc=> batch.update(doc.ref,{horario:novoHorario, obs:novasObs}));
    await batch.commit();
  }else{
    await alvoRef.update({horario:novoHorario, obs:novasObs});
  }

  fecharModalBanho();
  await renderCalendario();
}
async function excluirEsteBanho(){
  if(!modalBanhoId) return;
  if(!confirm('Deseja excluir apenas este banho?')) return;
  await db.collection('banhos').doc(modalBanhoId).delete();
  fecharModalBanho();
  await renderCalendario();
}
async function excluirPacote(){
  if(!modalBanhoId) return;
  const alvo=await db.collection('banhos').doc(modalBanhoId).get();
  const b=alvo.data();
  if(!b || !b.pacoteId) return;
  if(!confirm('Deseja excluir TODOS os banhos deste pacote?')) return;

  const snap=await db.collection('banhos').where('pacoteId','==',b.pacoteId).get();
  const batch=db.batch();
  snap.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();

  fecharModalBanho();
  await renderCalendario();
}

/* ==================== INICIALIZAÇÃO ==================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  togglePacoteOptions();
  // A UI será liberada após login (onAuthStateChanged).
});
</script>

</body>
</html>
